<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
		<style>
			a:link {text-decoration: none; color: black;}
			a:visited {text-decoration: none; color: black;}
			a:hover {text-decoration: none; color: white; background-color: red; font-weight: bold;}
			a:active {text-decoration: none; color: black;}
			button { width:40px; height:35px; padding: 0px 0px; }

			.buttonEdit{
				width:40px;
				height:32px;
				padding: 0px 0px;
			}

			.sliderImport{
				position:relative;
				left:-25px;
				top:50px;
				width:80px;
				height:20px;
				padding: 0px 0px;
				border:0px;
				transform: rotate(-90deg);
			}

		</style>
		<script type="text/javascript" src="colors.js"></script>

		
	</head>
	<body onunload="saveAnimation( selectedAnimation );">
	<table style="width: 100%;"><tr style="height:120px;"><td>
		<table style="width: 100%;">
			<tr style="height:120px;">
				<td style="vertical-align:top;">
					<h1>LEDitor</h1>
					<div id="helpInfoArea" data-i18n="settings.intro"></div>
				</td>
				<td>
					<img src="../assets/icon.svg" height="90" width="90" style="float: right;">
				</td>
			</tr>
		</table>

	</tr></td><tr><td>

		<table id="editor" style="position:absolute; width:840px; border-collapse: collapse;">
		<tr style="border: 1px solid Gainsboro;">
			<td colspan=3>
				<!-- **** Top Bar **** -->
				<table style="width:840px; height:32px; border-collapse: collapse;">
					<tr style="height: 32px;">
						<td style="width:35px; text-align: left;">
							<button id="but_copy_ani" title="copy full animation from..." style="position:relative; left:0px; top:0px; width:35px; height:32px; vertical-align:middle; padding: 0px 0px;" onclick = "clickAniCopy(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/ani_copy.png" height="30" width="30" style="float: center;"></button>
						</td>
						<td style="width: 120px; height: 32px; text-align: left;">
							<div style=" position:relative; top:0px; left:0px; width:120px; height:32px;">
								<select id="dropAnimation" name="dropAnimation" style="position:absolute; top:0px; left:0px; width: 120px; height:32px; padding:0px 0px;" onclick = "selectAnimation(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)" >
								<option value=""></option>
								</select>
								<input style="position:absolute; left:4px; top:4px; width:108px; height:20px; padding:0px 0px; border: 2px inset; visibility:hidden;" id="inName" type="text" oninput="changeAniName(this);" onchange="enterName(this);" onmouseover="this.focus(); showHelp(this, event);" onmouseout="showHelp(this, event)" titel="Enter animation name" />
							</div>
								
						</td>
						<td style="width:35px; text-align: left;">
							<button id="but_rename_ani" title="click to rename animation" style="position:relative; left:0px; top:0px; width:35px; height:32px; vertical-align:middle; padding: 0px 0px;" onclick = "clickAniRename(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/ani_rename.png" height="30" width="30" style="float: center;"></button>
						</td>
								

						<td style="width:80px; text-align: right;">
							<div id="frameCount" title=""></div>
						</td>

						<td style="text-align: left;">
								&nbsp;@ <input style="width:30px; height:20px; padding:0px 2px; border: 1px solid Gainsboro;" id="inFPS" type="number" value="1" min="1" max="30" oninput="changeNumberSetting(this);" onmouseover="this.focus(); showHelp(this, event);" onmouseout="showHelp(this, event)" titel="Frames Per Second" /> FPS,
								&nbsp;<input style="width:30px; height:20px; padding:0px 2px; border: 1px solid Gainsboro;" id="inTFPS" type="number" value="60" min="1" max="60" oninput="changeNumberSetting(this);" onmouseover="this.focus(); showHelp(this, event);" onmouseout="showHelp(this, event)" titel="Interpolated Frames Per Second" /> IFPS.

						</td>
						<td style="text-align: left;" id="aniTime">xxx.x sec.
						</td>
						<td style="text-align: left;">
							<input style="width:40px; height:20px; padding:0px 2px; border: 1px solid Gainsboro;" id="inRPM" type="number" value="0" min="-127" max="127" oninput="changeNumberSetting(this);" onmouseover="this.focus(); showHelp(this, event);" onmouseout="showHelp(this, event)" titel="Rotations Per Minute" /> RPM.
						</td>

						<td style="width:100px;">
							<div style=" position:relative; top:0px; left:0px; width:140px; height:32px;">
							<button id="butPlay" class="buttonEdit" style="position:absolute; left:0px; top:0px;" onclick="clickPlay(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/ani_play.png" height="30" width="30" style="float: center;"></button>
							<button id="butPreview" class="buttonEdit" style="position:absolute; left:50px; top:0px;" onclick="clickPrev(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/homey_play.png" height="30" width="30" style="float: center;"></button>
							<div style="position:absolute; left:91px; top:6px; width:30px; height:20px; padding:0px 2px;">x</div>
							<input id="inRepeat" style="position:absolute; left:102px; top:6px; width:30px; height:20px; padding:0px 2px; border: 1px solid Gainsboro;" type="number" value="1" min="1" max="20" oninput="changeNumberSetting(this);" onmouseover="this.focus(); showHelp(this, event);" onmouseout="showHelp(this, event)" />
							</div>
						</td>

						<td style="width:40px; font-size:12px; text-align:center;" id="repeatTime">00:00
						</td>
					</tr>
				</table>
			</td>
		</tr>
		<tr>
			<td style="width:400px; vertical-align: top;">

				<!-- list header -->
				<table style="width: 100%; border: 1px solid Gainsboro; border-collapse: collapse;">
					<tr style="background-color: Gainsboro;">
						<th id="headerFrame" title="" style="width: 40px; text-align: center;" data-i18n="settings.header_frame"></th>
						<th id="headerColors" title="" style="width: 240px; text-align: center;" data-i18n="settings.header_colors"></th>
						<td style="width: 120px;">
						</td>
						<td>&nbsp;</td>
					</tr>
				</table>

				<!-- frames list -->
				<div id="divFrameScroll" style="width: 400px; height: 376px; border: 1px solid Gainsboro; overflow: auto;">
					<table id="tableFrames" style="width: 100%; border-collapse: collapse;" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"></table>
				</div>

				<div id="divButtons" style=" position:relative; top:0px; left:0px; width:400px; height:32px;">
					<!-- frame add/copy/import buttons -->
					<button id="but_frame_add" class="buttonEdit" style="position:absolute; left:0px; top:0px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/frame_new.png" height="30" width="30" style="float: center;"></button>
					<button id="but_frame_copy" class="buttonEdit" style="position:absolute; left:40px; top:0px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/frame_duplicate.png" height="30" width="30" style="float: center;"></button>
					<!-- button id="but_image_export" class="buttonEdit" style="position:absolute; left:320px; top:0px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/image_export.png" height="30" width="30" style="float: center;"></button -->
					<button id="but_image_import" class="buttonEdit" style="position:absolute; left:360px; top:0px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/image_import.png" height="30" width="30" style="float: center;"></button>

					<!-- undo/redo buttons -->
					<button id="but_edit_undo" class="buttonEdit" style="position:absolute; left:720px; top:0px;" onclick="clickEditButton(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/edit_undo.png" height="30" width="30" style="float: center;"></button>
					<button id="but_edit_redo" class="buttonEdit" style="position:absolute; left:760px; top:0px;" onclick="clickEditButton(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/edit_redo.png" height="30" width="30" style="float: center;"></button>
				</div>
			</td>
			<td id="tdDisplay" style="vertical-align: top;">

				<!-- LED ring display -->
				<div id="parentRing" style="position:relative; left:0px; top:0px; width:400px; height:400px; background-color:#000000; overflow: hidden;">
					<div id="divRing" style="width:400px; height:400px;">
						<canvas id="canvRing" width="400" height="400" style="position:relative; left:0px; top:0px; width:400px; height:400px; filter: blur(0px);"></canvas>
						<canvas id="canvRing2" width="400" height="400" style="position:absolute; left:0px; top:0px; width:400px; height:400px; filter: blur(0px); transition-duration: 1s;"></canvas>
					</div>
					<canvas id="canvTop" width="400" height="400" style="position:absolute; left:0px; top:0px; width:400px; height:400px;"></canvas>
						

					<div id="nrFrame" style="position:absolute; left:330px; top:2px; height:20px; width:100px; text-align:left; font-size:12px;">Frame: 200</div>
					<div id="txtLedRing" style="position:absolute; left:200px; top:382px; height:18px; width:198px; text-align:right; font-size:9px;" data-i18n="settings.txt_ledring"></div>

					<!-- Central LED edit -->
					<div id="divEdit" style="top:0px; left:0px; width:400px; height:400px;">
						<svg id="linePointer" height="400" width="400" style="position:absolute; top:0px; left:0px; width:400px; height:400px;">
							<line id="lPointer" stroke-dasharray="2, 2" x1="0" y1="0" x2="200" y2="200" style="stroke:rgb(0,0,0); stroke-width:2;  transition: stroke .25s linear;visibility:hidden;" />
						</svg>

					<div id="ledMarkers" style="top:0px; left:0px; width:400px; height:400px;">
					</div>
						<img id="butTopColor" src="../assets/images/icon_bw.png" height="20" width="20" style="position:absolute; left:2px; top:2px; width:20px; height:20px; padding: 0px 0px; cursor:pointer;" onclick="changeTopColor();" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)">
						
						<div style="position:absolute; left:95px; top:150px; width:105px; height:20px; text-align:center; padding: 0px 0px;" data-i18n="settings.txt_processing">Edit</div>
						<select id="dropFillType" name="dropFillType" style="position:absolute; left:95px; top:170px; width:105px; height:20px; padding: 0px 0px;" onclick = "selectEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)" >
							<option value="type_1" data-i18n="settings.txt_drop_type_1">1 or more</option>
							<option value="type_2" data-i18n="settings.txt_drop_type_2">jump</option>
							<option value="type_3" data-i18n="settings.txt_drop_type_3">jump</option>
						</select>
						<div style="position:absolute; left:200px; top:150px; width:105px; height:20px; text-align:center; padding: 0px 0px;" data-i18n="settings.txt_range">Range</div>
						<select id="dropFillRange" name="dropFillRange" style="position:absolute; left:200px; top:170px; width:105px; height:20px; padding: 0px 0px;" onclick = "selectEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)" >
							<option value="fill_2" data-i18n="settings.ed_fill_range_2">to every 2nd LED</option>
						</select>

						<canvas id="colPreview" height="20" width="100" style="position:absolute; border-style:outset; border-width:1px; left:150px; top:210px; width:100px; height:20px; background-color:#000000; color: #ffffff; text-align: center; cursor:pointer;" onclick="clickEditButton(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)" data-i18n="settings.ed_apply_off"></canvas>
						<div style="position:absolute; left:150px; top:230px; width:100px; height:20px; color:#000000; text-align:center;" data-i18n="settings.txt_led_setting">LED status</div>

						<!-- **** color palette **** -->
						<div id="divColorPal" style="position:absolute; top:80px; left:80px; width:240px; height:240px; background-color: #000000;">
						</div>
					</div>
				</div>
			</td>
			<td style="width:40px;">
				<div id="divFrameEdit2" style=" position:relative; top:0px; left:0px; width:40px; height:432px;">
					<button id="but_frame_clock" class="buttonEdit" style="position:absolute; left:0px; top:0px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/rotate_clockwise.png" height="30" width="30" style="float: center;"></button>
					<button id="but_frame_counterclock" class="buttonEdit" style="position:absolute; left:0px; top:32px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/rotate_counter_clockwise.png" height="30" width="30" style="float: center;"></button>

					<button id="but_frame_push" class="buttonEdit" style="position:absolute; left:0px; top:80px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/shift_back.png" height="30" width="30" style="float: center;"></button>
					<button id="but_frame_pull" class="buttonEdit" style="position:absolute; left:0px; top:112px;" onclick = "clickFrameEdit(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/shift_front.png" height="30" width="30" style="float: center;"></button>

					<button id="but_edit_fill" class="buttonEdit" style="position:absolute; left:0px; top:160px;" onclick = "clickEditButton(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/fill_solid.png" height="30" width="30" style="float: center;"></button>
					<button id="but_edit_flow" class="buttonEdit" style="position:absolute; left:0px; top:192px;" onclick = "clickEditButton(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/fill_flow.png" height="30" width="30" style="float: center;"></button>
				</div>
			</td>
		</tr>

		<tr>
			<td colspan=3 style="vertical-align:top;">

			</td>
		</tr>
		</table>

	

		<!-- ***** image import ***** -->
		<table id="imageImporter" style="position:relative; left:0px; top:0px; width:844px; visibility:hidden; border-collapse: collapse;">
			<tr style="height:34px; background-color:#ffffff;">
				<th style="width:400px; background-color: Gainsboro; text-align:center;">
					
					<div data-i18n="settings.txt_led_colors">LED colors</div>
				</th>
				<td style="width:50px;background-color: Gainsboro; text-align:center;"></td>
				<th style="width:400px; background-color: Gainsboro; text-align:center;">
					<div data-i18n="settings.txt_image_selection"></div>
				</th>
			</tr>
			<tr style="position:absolute; left:0px; top:34px; height:433px; background-color:#ffffff;">
				<td style="width:400px;">
					<div id="divImageFrames" style="position:absolute; top:0px; left:0px; width: 400px; height: 398px; border: 1px solid Gainsboro; overflow: auto;">
						<canvas id="canvImportedFrames" width="380" height="390" style="position:relative; left:0px; top:0px;" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"></canvas>
					</div>
					<input type="file" accept="image/*" name="img" size="30" id="uploadimage" style="position:absolute; left:0px; top:400px; visibility:hidden;" />
					<button id="but_open_image" class="buttonEdit" style="position:absolute; left:0px; top:400px;" onclick = "uploadimage.click();" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img id="iconOpenImage" src="../assets/images/open_image.png" height="30" width="30" style="float: center;"></button>
					<button id="but_import_cancel" class="buttonEdit" style="position:absolute; left:360px; top:400px;" onclick = "closeImport(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/cancel.png" height="30" width="30" style="float: center;"></button>
					<button id="but_import_accept" class="buttonEdit" style="position:absolute; left:320px; top:400px;" onclick = "closeImport(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/accept.png" height="30" width="30" style="float: center;"></button>
					
				</td>
				<td style="width:40px;">
					<div style="position:absolute; left:400px; top:0px; width:40px; height:100px;">
						<div id="sliderDimmerVal" style="position:absolute; left:0px; top:2px; width:30px; height:15px; font-size:12px; text-align:center;">0</div>
						<input type="range" id="sliderDimmer" min="-0.99" max="0" step="0.01" value=0 class="sliderImport" oninput="sliderImportInput(this);" onwheel="sliderImportWheel(this, event);" ondblclick="sliderImportDouble(this);" onmouseover="this.focus(); showHelp(this, event)" onmouseout="showHelp(this, event)" />
						<div style="position: absolute; left:-8px; top:50px; width:80px; height:15px; font-size:12px; text-align:center; transform: rotate(-90deg);" data-i18n="settings.txt_dimmer">Dimmer</div>
					</div>
					<div style="position:absolute; left:400px; top:100px; width:40px; height:100px;">
						<div id="sliderHueVal" class="sliderImportVal" style="position:absolute; left:3px; top:2px; width:30px; height:15px; font-size:12px; text-align:center;">0&deg;</div>
						<input type="range" id="sliderHue" min="-0.5" max="0.5" step="0.0027777" value=0 class="sliderImport" oninput="sliderImportInput(this);" onwheel="sliderImportWheel(this, event);" ondblclick="sliderImportDouble(this);" onmouseover="this.focus(); showHelp(this, event)" onmouseout="showHelp(this, event)" />
						<div style="position: absolute; left:-8px; top:50px; width:80px; height:15px; font-size:12px; text-align:center; transform: rotate(-90deg);" data-i18n="settings.txt_hue">Hue</div>
					</div>
					<div style="position:absolute; left:400px; top:200px; width:40px; height:100px;">
						<div id="sliderSaturationVal" style="position:absolute; left:0px; top:2px; width:30px; height:15px; font-size:12px; text-align:center;">0</div>
						<input type="range" id="sliderSaturation" min="-1" max="1" step="0.01" value=0 class="sliderImport" oninput="sliderImportInput(this);" onwheel="sliderImportWheel(this, event);" ondblclick="sliderImportDouble(this);" onmouseover="this.focus(); showHelp(this, event)" onmouseout="showHelp(this, event)" />
						<div style="position: absolute; left:-8px; top:50px; width:80px; height:15px; font-size:12px; text-align:center; transform: rotate(-90deg);" data-i18n="settings.txt_saturation">Saturation</div>
					</div>
					<div style="position:absolute; left:400px; top:300px; width:40px; height:100px;">
						<div id="sliderLightnessVal" style="position:absolute; left:0px; top:2px; width:30px; height:15px; font-size:12px; text-align:center;">0</div>
						<input type="range" id="sliderLightness" min="-0.995" max="0.995" step="0.005" value=0 class="sliderImport" oninput="sliderImportInput(this);" onwheel="sliderImportWheel(this, event);" ondblclick="sliderImportDouble(this);" onmouseover="this.focus(); showHelp(this, event)" onmouseout="showHelp(this, event)" />
						<div style="position: absolute; left:-8px; top:50px; width:80px; height:15px; font-size:12px; text-align:center; transform: rotate(-90deg);" data-i18n="settings.txt_lightness">Lightness</div>
					</div>
				</td>
				<td style="width:400px;">
					<canvas id="canvImage" width="400" height="400" style="position:absolute; left:2px; top:2px;" onmousedown="imageMouseDown(this, event)" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"></canvas>
					<div id="importArea" style="position:absolute; left:0px; top:0px; border: 2px dotted #000000; transition: border-color .5s linear;" onmousedown="imageMouseDown(this, event);" onmousemove="imageMouseMove(event);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)">
						<canvas id="canvImport" width="200" height="24" style="visibility:hidden; position:absolute; left:0px; top:0px;"></canvas>
						<canvas id="canvImportV" width="200" height="24" style="position:absolute; left:0px; top:0px;"></canvas>
					</div>
					<button id="but_scan_direction" class="buttonEdit" style="position:absolute; left:444px; top:400px;" onclick="changeScanAspect()" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img id="iconScanDir" src="../assets/images/scan_right.png" height="30" width="30" style="float: center;"></button>
					<div style="position:absolute; left:504px; top:400px; width:80px; height:32px;">
						<input id="inFrames" style="width:40px; height:20px; padding:0px 2px; border: 1px solid Gainsboro;" type="number" value="200" min="1" max="200" oninput="changeNumberSetting(this);" onmouseover="this.focus(); showHelp(this, event)" onmouseout="showHelp(this, event)" titel="Number of animation frames" /><div style="font-size:12px">frames</div>
					</div>
					<div style="position:absolute; left:680px; top:400px; width:160px; height:32px;">
						<div style="position:absolute; left:0px; top:-2px; width:80px; height:15px; font-size:12px; text-align:right;" data-i18n="settings.txt_zoom">Zoom</div>
						<div id="sliderZoomVal" style="position:absolute; left:90px; top:-2px; width:70px; height:15px; font-size:12px; text-align:left;">100%</div>
						<input type="range" id="sliderZoom" min="0" max="0.99" step="0.0025" value=0 style="position:absolute; left:0px; top:20px; width:160px; height:10px; padding: 0px 0px; border:0px;" oninput="sliderImportInput(this);" onwheel="sliderImportWheel(this, event);" ondblclick="sliderImportDouble(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)" />
					</div>
				</td>
			</tr>
		</table>

		<!-- ***** image export ***** -->
		<table id="imageExporter" style="position:relative; left:0px; top:-34px; width:844px; visibility:hidden; border-collapse: collapse;">
			<tr style="height:34px; background-color:#ffffff;">
				<th style="background-color: Gainsboro; text-align:center;">
					<button id="but_export_cancel" class="buttonEdit" style="position:absolute; left:800px; top:2px;" onclick = "closeExport(this);" onmouseover="showHelp(this, event)" onmouseout="showHelp(this, event)"><img src="../assets/images/cancel.png" height="30" width="30" style="float: center;"></button>
				</th>
			</tr>
			<tr  style="height:150px; background-color:#ffffff;">
				<th style="text-align:center;">
					<canvas id="canvImageExport" width="200" height="24" style="background-color:#808080;"></canvas>
				</th>
			</tr>
			<tr  style="height:250px; background-color:#ffffff;">
				<td style="text-align:left; vertical-align:top;">
				Right-click the image above and select 'save image as...' to export the animation. Anybody can import this image into their personal LEDitor and create an animation from it.
				</td>
			</tr>
		</table>

	</td></tr></table>

		<script type="text/javascript">
		var 	selectedAnimation = 0,
			playFrame = 0,
			selectedFrame = 0,
			undoList = [], undoPointer = -1;
	
		var max_fields	= 200;	//maximum frames allowed
		var count_frames = 0;	//used frames
		var replacements = {};
		var docFrames = document.getElementById("tableFrames");
		var saveStandby = 0;
		var 	txtUsed =  '',
			txtFree = '',
			txtUpdated = '',
			txtMoveUp = '',
			txtMoveDown = '',
			txtRemove = '',
			txt_frame_add = '',
			txt_frame_copy = '',
			txt_ani_copy = '',
			txt_ed_apply_off = '',
			txt_drop_type = [],
			txt_drop_range = [],
			txt_plural_s = '',
			txt_count = [],
			helpText = {};

		var 	ctxRing = canvRing.getContext("2d"),				// ring colors
			ctxRing2 = canvRing2.getContext("2d"),				// ring colors 2
			ctxTop = canvTop.getContext("2d"),				// Homey's case
			butAddFrame = document.getElementById("but_frame_add"),
			butCopyFrame = document.getElementById("but_frame_copy"),
			butUndo = document.getElementById("but_edit_undo"),
			butRedo = document.getElementById("but_edit_redo"),
			butClock = document.getElementById("but_frame_clock"),
			butCounterClock = document.getElementById("but_frame_counterclock"),
			butPush = document.getElementById("but_frame_push"),
			butPull = document.getElementById("but_frame_pull"),
			butCopyAni = document.getElementById("but_copy_ani"),
			butRenameAni = document.getElementById("but_rename_ani"),
			valFillType = '',
			valFillRange = '',

			editW = 400,				// display canvas width/height
			editW2 = editW/2,
			ledEditW = Math.floor(editW/25),	// size of led-color indicators/selectors
			caseRadius = editW * 0.43,
			ledW = editW,				// max. radiation radius for leds
			topColor = 3,				// editor color outside led-ring - 0...3 (black, 33% grey, 67% grey, white)

			ledFrame = [],				// container for 24 LED objects {r:<0...255>, g:<0...255>, b:<0...255>}
			ledFrames = [],				// container for multiple ledFrames
			valRPM = 10,				// rotations per minute
			valFPS = 1,				// animation frames per second
			valTFPS = 60,				// target view frames per second
			playMode = false;			// preview mode true/false

		canvImportedFrames

		// led color markers
		tempCode = '';
		for( var i=0; i<24; i++){
			tempCode += ('<div id="ledMarker' + i + '" style="position:absolute; left:0px; top:0px; width:10px; height:10px; background-color:#000000; transition: border-color .25s linear; cursor:pointer;" onclick="clickLedMarker(this);" onmouseover="showActiveLeds(this); showHelp(this, event)" onmouseout="resetShowActive(); showHelp(this, event);" title="Click to colorize"></div>');
		}
		ledMarkers.innerHTML = tempCode; tempCode = null;

		parentRing.style.width = editW + 'px';
		parentRing.style.height = editW + 'px';
		divRing.style.width = editW + 'px';
		divRing.style.height = editW + 'px';
		canvRing.width = editW;
		canvRing.height = editW;
		canvRing.style.width = editW + 'px';
		canvRing.style.height = editW + 'px';
		canvRing2.width = editW;
		canvRing2.height = editW;
		canvRing2.style.width = editW + 'px';
		canvRing2.style.height = editW + 'px';
		canvTop.width = editW;
		canvTop.height = editW;
		canvTop.style.width = editW + 'px';
		canvTop.style.height = editW + 'px';

		// create empty frame & fill ledFrame empty
		var emptyFrame = []
		for( i = 0; i < 24; i++ ){
			emptyFrame[i] = { r:0, g:0, b:0 };
			ledFrame[i] = { r:0, g:0, b:0 };
		}
		ledFrames = [ledFrame];


		refreshButtons(false);

		function onHomeyReady(){
			Homey.ready();

			txtRemove = __('settings.remove');
			txtUsed = __('settings.used');
			txtFree = __('settings.free');
			txtMoveUp = __('settings.move_up');
			txtMoveDown = __('settings.move_down');
			txtUpdated = __('settings.updated');
			txt_ed_apply_off = __('settings.ed_apply_off');

			txt_frame_add = __('settings.frame_button_add');
			txt_frame_copy = __('settings.frame_button_copy');
			txt_ani_copy = __('settings.animation_button_copy');

			butCopyAni.title = txt_ani_copy.replace('###', selectedAnimation+1);

			butAddFrame.title = txt_frame_add.replace( '###', selectedFrame+1 );
			butCopyFrame.title = txt_frame_copy.replace( '###', selectedFrame+1 );
			butPush.title = __('settings.frame_button_push');
			butPull.title = __('settings.frame_button_pull');
			butClock.title = __('settings.frame_button_clock');
			butCounterClock.title = __('settings.frame_button_counterclock');
			butUndo.title = __('settings.txt_undo');
			butRedo.title = __('settings.txt_redo');

			but_edit_fill.title = __('settings.ed_fill_equal');
			but_edit_flow.title = __('settings.ed_fill_gradient');

			txt_drop_type[0] = __('settings.txt_drop_type_1');
			txt_drop_type[1] = __('settings.txt_drop_type_2');
			txt_drop_type[2] = __('settings.txt_drop_type_3');
			txt_drop_range[0] = __('settings.txt_drop_range_t1');
			txt_drop_range[1] = __('settings.txt_drop_range_t2');
			txt_drop_range[2] = __('settings.txt_drop_range_t3');
			txt_select = __('settings.txt_select');
			txt_plural_s = __('settings.txt_plural_s');
			txt_pure_red = __('settings.txt_pure_red');
			txt_pure_green = __('settings.txt_pure_green');
			txt_pure_blue = __('settings.txt_pure_blue');
			txt_pure_yellow = __('settings.txt_pure_yellow');
			txt_pure_magenta = __('settings.txt_pure_magenta');
			txt_pure_cyan = __('settings.txt_pure_cyan');
			txt_bright_white = __('settings.txt_bright_white');
			txt_no_color = __('settings.txt_no_color');

			for( var i = 0; i < 13; i ++ ){
				txt_count[i] = __( 'settings.count' + i );
			}

			but_import_cancel.title = __('settings.txt_import_cancel');
			but_import_accept.title = __('settings.txt_import_accept');
			but_open_image.title = __('settings.txt_open_image');
			but_scan_direction.title = __('settings.txt_scan_direction');


			var help_index = [
				'but_copy_ani_A', 'but_copy_ani_B',
				'dropAnimation_A', 'dropAnimation_B', 'but_rename_ani',
				'inName', 'inFPS', 'inTFPS', 'inRPM',
				'butPlay', 'butPreview', 'inRepeat',
				'tableFrames', 'butTopColor',
				'ledMarker', 'colPreview', 'dropFillType', 'dropFillType1', 'dropFillType2', 'dropFillType3', 'dropFillType1ext', 'dropFillType2ext', 'dropFillType3ext', 'dropFillRange',
				'but_frame_clock', 'but_frame_counterclock', 'but_frame_push', 'but_frame_pull',
				'but_edit_fill', 'but_edit_flow', 'but_frame_add', 'but_frame_copy', 'but_image_import', 'but_edit_undo', 'but_edit_redo',

				'sliderDimmer', 'sliderHue', 'sliderSaturation', 'sliderLightness', 'sliderZoom',
				'but_open_image', 'but_scan_direction', 'inFrames',
				'canvImage', 'importArea', 'canvImportedFrames',
				'but_import_cancel', 'but_import_accept'
			];
			for( var i = 0; i < help_index.length; i ++ ){
				helpID = 'settings.help_' + help_index[i];
				helpText[ help_index[i] ] = __( 'settings.help_' + help_index[i] );
			}
			helpText.Default = __('settings.intro');

			ledSelectPreview( {r:0, b:0, g:0} );

			Homey.get('topColor', function( err, tColor ){
				if ( tColor == undefined ){
					tColor = 3;
				}
				topColor = tColor;
				drawTop();
			});

			// create color selection palette.
			// color selectors
			tempCode = '';
			for( var j=0; j< stepColBright*2+1 ; j++){
				for( var i=0; i<colBase.length; i++){										
					tempCode += ('<div id="colSet' + (colBase.length * j + i) + '" style="position:absolute; left:0px; top:0px; width:13px; height:13px; cursor:pointer;" onclick="clickColorPalette(this);" title=""></div>');
				}
			}
			divColorPal.innerHTML = tempCode;

			var bWidth = 1, cWidth = 19, xWidth = (cWidth+bWidth*2);
			for( var j=0; j< stepColBright*2+1 ; j++){
				for( var i=0; i<colBase.length; i++){
					xColSet = document.getElementById('colSet' + (colBase.length * j + i) );
					xColSet.style.width = cWidth + 'px';
					xColSet.style.height = cWidth + 'px';
					xColSet.style.left = (i * xWidth) + 'px';
					xColSet.style.top = (j* xWidth) + 'px';
					xColSet.style.borderWidth = bWidth + 'px';
					xColSet.style.borderColor = '#000000';
					xColSet.style.borderStyle = 'solid';
					xColSet.style.color = '#ffffff';
					xColSet.style.textAlign = 'center';
					var strCol = colPal[colBase.length * j + i].r + ',' + colPal[colBase.length * j + i].g + ',' + colPal[colBase.length * j + i].b;
					var vColor = getViewColor( colPal[colBase.length * j + i] );
					var viewCol = vColor.r + ',' + vColor.g + ',' + vColor.b;

					xColSet.style.backgroundColor = 'rgba(' + viewCol + ',1)';
					switch( strCol ){
					case '0,0,0'	: xColSet.innerHTML = 'X'; xColSet.style.color = '#ffffff'; xColSet.title = txt_select + ': ' + txt_no_color; break;
					case '255,0,0'	: xColSet.innerHTML = '*'; xColSet.style.color = '#ffffff'; xColSet.title = txt_select + ': ' + txt_pure_red; break;
					case '0,255,0'	: xColSet.innerHTML = '*'; xColSet.style.color = '#000000'; xColSet.title = txt_select + ': ' + txt_pure_green; break;
					case '0,0,255'	: xColSet.innerHTML = '*'; xColSet.style.color = '#ffffff'; xColSet.title = txt_select + ': ' + txt_pure_blue; break;
					case '255,255,0': xColSet.innerHTML = '*'; xColSet.style.color = '#000000'; xColSet.title = txt_select + ': ' + txt_pure_yellow; break;
					case '255,0,255': xColSet.innerHTML = '*'; xColSet.style.color = '#ffffff'; xColSet.title = txt_select + ': ' + txt_pure_magenta; break;
					case '0,255,255': xColSet.innerHTML = '*'; xColSet.style.color = '#000000'; xColSet.title = txt_select + ': ' + txt_pure_cyan; break;
					case '255,255,255': xColSet.innerHTML = ''; xColSet.style.color = '#000000'; xColSet.title = txt_select + ': ' + txt_bright_white; break;
					}
				}
			}
			divColorPal.style.width = (colBase.length * xWidth + 1) + 'px';
			divColorPal.style.height = ( (stepColBright*2+1) * xWidth + 1) + 'px';
			divColorPal.style.left = (editW2 - divColorPal.offsetWidth/2 ) + 'px';
			divColorPal.style.top = (editW2 - divColorPal.offsetHeight/2 ) + 'px';
			divColorPal.style.visibility = 'hidden';


			openAnimationIndex();
			openAnimation();

			selectEdit({id:'dropFillType', value:'type_1'});


			var ctxImp = canvImportedFrames.getContext("2d");
			ctxImp.font = '20px sans-serif';
			ctxImp.lineWidth = '1px';
			ctxImp.fillStyle = '#800000';
			ctxImp.fillRect( 19, 330, 2, 60);
			ctxImp.fillText( __('settings.txt_import_start'), 2, 320 );
			

		}



	function showHelp( obj, event ){
		var docHelp = document.getElementById('helpInfoArea');
		var id = obj.id;
		if( id.substr(0,9) == 'ledMarker' ){
			id = 'ledMarker';
		}
		switch(id){
			case 'ledMarker':
				break;

			case'dropAnimation':
				switch( enableAniCopy ){
					case false: id = id + '_A'; break;
					case true: id = id + '_B'; break;
				}
				break;

			case'but_copy_ani':
				switch( enableAniCopy ){
					case false: id = id + '_A'; break;
					case true: id = id + '_B'; break;
				}
				break;
		}

		switch(event.type){
			case'mouseover':
				docHelp.style.fontWeight = 'bold';
				docHelp.style.color = '#800000';
				if( helpText[ id ] == undefined ){
					docHelp.innerHTML = 'Missing: helpText.' + id;
				} else {
					var txtHelp = helpText[ id ];
					switch(id){
						case'dropFillType':
							txtHelp = txtHelp + ' ' + helpText[ 'dropFillType1' ] + ' ' + helpText[ 'dropFillType2' ] + ' ' + helpText[ 'dropFillType3' ];
							break;

						case'dropFillRange':
							var xType = dropFillType.value.substr(5);
							txtHelp = txtHelp + ': ';
							if( xType == '3' ){ txtHelp = ''; }
							txtHelp = txtHelp + helpText[ 'dropFillType' + xType ];
							break;

						case'colPreview':
							if( dropFillType.value == 'type_3' ){
								docHelp.style.fontWeight = 'normal';
								docHelp.style.color = document.body.style.color;
								txtHelp = helpText[ 'Default' ];
							}
							break;

						
					}
					switch(id){
						case'dropFillType': case'dropFillRange':
							txtHelp = txtHelp.replace( '#1#', txt_drop_type[0] );
							txtHelp = txtHelp.replace( '#2#', txt_drop_type[1] );
							txtHelp = txtHelp.replace( '#3#', txt_drop_type[2] );

							var xType = dropFillType.value.substr(5);
							if( id == 'dropFillRange' ){ txtHelp = txtHelp + ' ' + helpText[ 'dropFillType' + xType + 'ext' ]}
							break;
					}

					docHelp.innerHTML = txtHelp;
				}
				break;

			case'mouseout':
				docHelp.style.fontWeight = 'normal';
				docHelp.style.color = document.body.style.color;
				docHelp.innerHTML = helpText[ 'Default' ];
				break;
		}
	}



// ******************** Start Image import code ********************

	var 	imgImport = null,
		imgImportData,
		scanAspect = 0, // 0 = Left-Right, 1 = Up-Down
		imgImportClick = {
			layerX:0,
			layerY:0,
			centerX:0,
			centerY:0
		},
		tableEditor = document.getElementById('editor'),
		blinkInterval = 0,

		prevSize = 396,
		previewL = 0, previewT = 0, previewW = prevSize, previewH = prevSize,
		imgSelectW = 0, imgSelectH = 0, imgSelectL = 0, imgSelectT = 0,
		imgSelectImportL = 0, imgSelectImportT = 0, imgSelectImportW = 0, imgSelectImportH = 0,
		importL = 0, importT = 0, importW = 0, importH = 0;

	canvImage.style.left = (2 + 840 - prevSize) + 'px';
	canvImage.style.top = 2 + 'px';
	canvImage.width = prevSize; canvImage.height = prevSize;
	var ctxImage = canvImage.getContext('2d');
	ctxImage.strokeRect(0, 0, canvImage.width, canvImage.height);


	function draw(ev) {
		if( document.getElementById("uploadimage").files[0] == undefined ){ return;}

		var	f = document.getElementById("uploadimage").files[0],
			url = window.URL || window.webkitURL,
			src = url.createObjectURL(f);

		imgImport = new Image();

		var frame = [], frame = [];
		imgImport.src = src;
		imgImport.onload = function() {
			sliderZoom.value = 0;
			imgImportClick = {
				layerX:0,
				layerY:0,
				centerX:Math.round( imgImport.width/2),
				centerY:Math.round( imgImport.height/2)
			}
			importL = 0; importT = 0; importW = 0; importH = 0;

			setupImportArea();
			url.revokeObjectURL(src);
			refreshButtons();
			refreshImageData();
		}
	}

	document.getElementById("uploadimage").addEventListener("change", draw, false);


	function setupImportArea(){
		var	imgImportW = imgImport.width,
			imgImportH = imgImport.height,
			ctx = canvImport.getContext('2d'),
			ctx2 = canvImage.getContext('2d'),
			f = document.getElementById("uploadimage").files[0],
			url = window.URL || window.webkitURL,
			src = url.createObjectURL(f);


		// setup preview
		var zoomFactor = 1 - sliderZoom.value;

		imgSelectW = Math.round( imgImportW * zoomFactor );
		imgSelectH = Math.round( imgImportH * zoomFactor );

		// adapt preview selection to zoom
		if(imgSelectW > imgSelectH){
			if( imgSelectH < imgImportH ){
				imgSelectH = imgImportH;
			}
			if( imgSelectH > imgSelectW ){ imgSelectH = imgSelectW; }
		} else {
			if( imgSelectW < imgImportW ){
				imgSelectW = imgImportW;
			}
			if( imgSelectW > imgSelectH ){ imgSelectW = imgSelectH; }
		}
		imgSelectL = Math.round( imgImportW / 2  - imgSelectW / 2 );
		imgSelectT = Math.round( imgImportH / 2  - imgSelectH / 2 );

		if(imgSelectW > imgSelectH){
			previewL = 0;
			previewW = prevSize;
			previewH = Math.round( prevSize / imgSelectW * imgSelectH );
			previewT = Math.round( ( prevSize - previewH) / 2);
		} else {
			previewT = 0;
			previewH = prevSize;
			previewW = Math.round( prevSize / imgSelectH * imgSelectW );
			previewL = Math.round( (prevSize - previewW) / 2);
		}

		var	xCenter = imgImportClick.centerX,
			yCenter = imgImportClick.centerY;

		imgSelectL = Math.round( xCenter - imgSelectW / 2 );
		if( imgSelectL < 0 ){ imgSelectL = 0; }
		if( imgSelectL + imgSelectW > imgImportW ){ imgSelectL = imgImportW - imgSelectW; }

		imgSelectT = Math.round( yCenter - imgSelectH / 2 );
		if( imgSelectT < 0 ){ imgSelectT = 0; }
		if( imgSelectT + imgSelectH > imgImportH ){ imgSelectT = imgImportH - imgSelectH; }

		ctx2.fillStyle = '#ffffff';
		ctx2.strokeStyle = '#404040';
		ctx2.fillRect(0, 0, prevSize, prevSize);
		ctx2.strokeRect(0, 0, prevSize, prevSize);
		ctx2.drawImage( imgImport, imgSelectL, imgSelectT, imgSelectW, imgSelectH, previewL, previewT, previewW, previewH );


		switch(scanAspect){
			case 0: // l-r
				importL = 0;
				importW = previewW;
				importH = Math.round( importW * 0.12 );

				canvImport.width = inFrames.value;
				canvImport.height = 24;
				break;

			case 1: // u-d
				importT = 0;
				importH = previewH;
				importW = Math.round( importH * 0.12 );

				canvImport.width = 24;
				canvImport.height = inFrames.value;
				break;
		}

		// *** replace select area ***
		imgImportClick.layerX = Math.round( ( xCenter - imgSelectL ) / ( imgSelectW / previewW ) + previewL );
		imgImportClick.layerY = Math.round( ( yCenter - imgSelectT ) / ( imgSelectH / previewH ) + previewT );

		importArea.style.left = ( canvImage.offsetLeft + previewL - 2 ) + 'px';
		importArea.style.top = (canvImage.offsetTop + previewT - 2 ) + 'px';
		importArea.style.width = importW + 'px';
		importArea.style.height = importH + 'px';

		canvImportV.width = importW;
		canvImportV.height = importH;
		canvImportV.style.width = importArea.style.width;
		canvImportV.style.height = importArea.style.height;

		// draw pixels
		importImageArea();

		switch(scanAspect){
			case 0: imgImportData = ctx.getImageData(0,0,inFrames.value,24); break;
			case 1: imgImportData = ctx.getImageData(0,0,24,inFrames.value); break;
		}

		// draw led matrix
		importImageToMatrix();
	}


	function changeScanAspect(){
		scanAspect ++; if(scanAspect == 2 ){ scanAspect = 0;}
		var butScandir = document.getElementById("but_scan_direction");
		switch(scanAspect){
			case 0: bAspect = 'scan_right'; break;
			case 1: bAspect = 'scan_down'; break;
		}
		butScandir.innerHTML = '<img src="../assets/images/' + bAspect + '.png" height="30" width="30" style="float: center;">';
		setupImportArea();
		refreshImageData();
	}

	function importImageArea(){
		switch(scanAspect){
			case 0: // l-r
				imgSelectImportL = imgSelectL;
				imgSelectImportW = imgSelectW;
				imgSelectImportH = imgSelectW * 0.12;
				imgSelectImportT = imgSelectH / previewH * (importT - previewT) + imgSelectT;
				var cnvW = inFrames.value, cnvH = 24;
				break;

			case 1: // u-d
				imgSelectImportT = imgSelectT;
				imgSelectImportH = imgSelectH;
				imgSelectImportW = imgSelectH * 0.12;
				imgSelectImportL = imgSelectW / previewW * (importL - previewL) + imgSelectL;
				var cnvW = 24, cnvH = inFrames.value;
				break;
		}
		var ctx = document.getElementById('canvImport').getContext('2d');
		ctx.drawImage(imgImport, imgSelectImportL, imgSelectImportT, imgSelectImportW, imgSelectImportH, 0, 0, cnvW, cnvH );
	}

	function importImageToMatrix(){
		// copy imgImportData to matrix area & import area
		if( imgImport == null ){ return; }
		var	ctx3 = canvImportedFrames.getContext('2d'),
			ctxV = canvImportV.getContext('2d'),
			colorW = 15,
			colorH = 10,
			vSpace = 5,
			colorL = ( canvImportedFrames.width - 24 * colorW ) / 2;

		ctxV.fillStyle = '#000000';
		ctxV.fillRect(0,0,canvImportV.width, canvImportV.height);
		canvImportedFrames.height = inFrames.value * (colorH + vSpace);
		ctx3.fillStyle = '#000000';
		ctx3.fillRect( 0, 0, canvImportedFrames.width, canvImportedFrames.height )

		switch(scanAspect){
			case 0: // l-r
				var	pixelSizeW = previewW / inFrames.value,
					pixelSizeH = previewW * 0.12 /24;

				for( var x = 0; x < inFrames.value; x++ ){
					for( var y = 0; y < 24; y++ ){
						var pixelIndex = (y * inFrames.value + x) * 4;
						var lCol = adjustColor({ r:imgImportData.data[ pixelIndex ], g:imgImportData.data[ pixelIndex + 1 ], b:imgImportData.data[ pixelIndex + 2 ] });
						var vCol = getViewColor( lCol );

						ctxV.fillStyle='rgba( ' + vCol.r + ', ' + vCol.g + ', ' + vCol.b + ',1 )';
						ctxV.fillRect( Math.round( x * pixelSizeW ), Math.round( y * pixelSizeH ), Math.ceil( pixelSizeW ), Math.ceil( pixelSizeH ) );
						
						if( vCol.r == 0 && vCol.g == 0 && vCol.b == 0 ){
							ctx3.fillStyle='#7f7f7f';
							ctx3.fillRect( colorL + ( 23 - y ) * colorW + colorW/2, x * (colorH + vSpace) + colorH/2, 1, 1 );
						} else {
							ctx3.fillStyle='rgba( ' + vCol.r + ', ' + vCol.g + ', ' + vCol.b + ',1 )';
							ctx3.fillRect( colorL + ( 23 - y ) * colorW, x * (colorH + vSpace), colorW-1, colorH );
						}
					}
					ctx3.fillStyle='#7f7f7f';
					ctx3.fillRect( colorL + 11 * colorW + colorW/2 - 1, x * (colorH + vSpace) + colorH, 2, vSpace );
				}
				break;

			case 1: // u-d
				var	pixelSizeH = previewH / inFrames.value,
					pixelSizeW = previewH * 0.12 / 24;

				for( var x = 0; x < 24; x++ ){
					for( var y = 0; y < inFrames.value; y++ ){
						var pixelIndex = (y * 24 + x) * 4;

						var lCol = adjustColor({ r:imgImportData.data[ pixelIndex ], g:imgImportData.data[ pixelIndex + 1 ], b:imgImportData.data[ pixelIndex + 2 ] });
						var vCol = getViewColor( lCol );
				
						ctxV.fillStyle='rgba( ' + vCol.r + ', ' + vCol.g + ', ' + vCol.b + ',1 )';
						ctxV.fillRect( Math.round( x * pixelSizeW ), Math.round( y * pixelSizeH ), Math.ceil( pixelSizeW ), Math.ceil( pixelSizeH ) );

						if( vCol.r == 0 && vCol.g == 0 && vCol.b == 0 ){
							ctx3.fillStyle='#7f7f7f';
							ctx3.fillRect( colorL + x * colorW + colorW/2, y * (colorH + vSpace) + colorH/2, 1, 1 );
						} else {
							ctx3.fillStyle='rgba( ' + vCol.r + ', ' + vCol.g + ', ' + vCol.b + ',1 )';
							ctx3.fillRect( colorL + x * colorW, y * (colorH + vSpace), colorW-1, colorH );
						}
						if( x == 0 ){
							ctx3.fillStyle='#7f7f7f';
							ctx3.fillRect( colorL + 11 * colorW + colorW/2 - 1, y * (colorH + vSpace) + colorH, 2, vSpace );
						}
					}
				}
				break;
		}
	}

	function importImageToFrames(){
		// copy imgImportData to frames
		switch(scanAspect){
			case 0: // l-r
				var frames = [];
				for( var x = 0; x < inFrames.value; x++ ){
					var frame = [];
					for( var y = 0; y < 24; y++ ){
						var pixelIndex = (y * inFrames.value + x) * 4;
						var lCol = adjustColor({ r:imgImportData.data[ pixelIndex ], g:imgImportData.data[ pixelIndex + 1 ], b:imgImportData.data[ pixelIndex + 2 ] });
						var vCol = getViewColor( lCol );
						var ledNr = y + 9; if( ledNr < 0 ){ ledNr +=24; } else if( ledNr > 23 ){ ledNr -=24; }
						frame[ ledNr ] = { r:vCol.r, g:vCol.g, b:vCol.b };
					}
					frames.push( frame );
				}
				break;

			case 1: // u-d
				var frames = [];
				for( var y = 0; y < inFrames.value; y++ ){
					var frame = [];
					for( var x = 0; x < 24; x++ ){
						var pixelIndex = (y * 24 + x) * 4;

						var lCol = adjustColor({ r:imgImportData.data[ pixelIndex ], g:imgImportData.data[ pixelIndex + 1 ], b:imgImportData.data[ pixelIndex + 2 ] });
						var vCol = getViewColor( lCol );
						var ledNr = 23 - x + 9; if( ledNr < 0 ){ ledNr +=24; } else if( ledNr > 23 ){ ledNr -=24; }
						frame[ ledNr ] = { r:vCol.r, g:vCol.g, b:vCol.b };
					}
					frames.push( frame );
				}
				break;
		}

		ledFrame = frame;
		ledFrames = [].concat(frames);
		valRPM = 0; valFPS = 10; valTFPS = 60;
		inRPM.value = valRPM;
		inFPS.value = valFPS;
		inTFPS.value = valTFPS;
		refreshFramesList();
		refreshLedSelectors();
		drawLedRing();
		drawAllFramePreviews();	
		saveAnimation();
		refreshCounter(); 
		refreshCounter( ledFrames.length );
		actionUndo();
		showAnimationTime();
	}

	function adjustColor(col){ // col = { r:, g:, b: }
		var	cR = col.r,
			cG = col.g,
			cB = col.b,
			brightVal = Number(sliderDimmer.value);

		if( brightVal < 0 ){
			cR = cR * ( 1 + brightVal);
			cG = cG * ( 1 + brightVal);
			cB = cB * ( 1 + brightVal);
		} else {
			cR = 255 - (( 255-cR ) * ( 1 - brightVal ));
			cG = 255 - (( 255-cG ) * ( 1 - brightVal ));
			cB = 255 - (( 255-cB ) * ( 1 - brightVal ));
		}
		colHSL = rgbToHsl(cR, cG, cB);

		colHSL[0] += Number(sliderHue.value);
		colHSL[1] += Number(sliderSaturation.value);
		colHSL[2] += Number(sliderLightness.value);
		if( colHSL[0] > 1 ){ colHSL[0] = colHSL[0] - 1; } else if( colHSL[0] < 0 ){ colHSL[0] + 1; }
		if( colHSL[1] > 1 ){ colHSL[1] = 1; } else if( colHSL[1] < 0 ){ colHSL[1] = 0; }
		if( colHSL[2] > 1 ){ colHSL[2] = 1; } else if( colHSL[2] < 0 ){ colHSL[2] = 0; }

		col = hslToRgb(colHSL[0], colHSL[1], colHSL[2]);
		return { r:col.r, g:col.g, b:col.b };
	}

	function imageMouseDown( obj, objEvent ){
		if( imgImport == null ){ return; }
		switch( obj.id ){
		case 'canvImage':
			imgImportClick.layerX = objEvent.layerX;
			imgImportClick.layerY = objEvent.layerY;
			var x = imgImportClick.layerX;
    			var y = imgImportClick.layerY;
			break;

		case 'importArea':
			imgImportClick.layerX = objEvent.layerX + importArea.offsetLeft - canvImage.offsetLeft + 2;
			imgImportClick.layerY = objEvent.layerY + importArea.offsetTop - canvImage.offsetTop + 2;
			var x = imgImportClick.layerX;
    			var y = imgImportClick.layerY;
			break;
		}
		imgImportClick.centerX = Math.round( ( imgImportClick.layerX - previewL ) * ( imgSelectW / previewW ) + imgSelectL );
		imgImportClick.centerY = Math.round( ( imgImportClick.layerY - previewT ) * ( imgSelectH / previewH ) + imgSelectT );
		refreshImageData();
	}

	function refreshImageData(){
		var	ctx = document.getElementById('canvImport').getContext('2d');
		switch(scanAspect){
			case 0:
				divImageFrames.scrollTop = ( inFrames.value / previewW ) * ( imgImportClick.layerX - ( prevSize - previewW ) / 2 ) * 15 - divImageFrames.offsetHeight / 2;
				
				importT = (imgImportClick.layerY - Math.round( importH / 2 ) );
				if( importT < previewT ){
					importT = previewT;
				} else if( importT > previewT + previewH - importH ){
					importT = previewT + previewH - importH;
				}
				importArea.style.top = ( importT ) + 'px';
				importImageArea();
				imgImportData = ctx.getImageData(0,0,inFrames.value,24);
				break;

			case 1:
				divImageFrames.scrollTop = ( inFrames.value / previewH ) * ( imgImportClick.layerY - (prevSize - previewH) / 2 ) * 15 - divImageFrames.offsetHeight / 2;

				importL = (imgImportClick.layerX - Math.round( importW / 2 ) );
				if( importL < previewL ){
					importL = previewL;
				} else if( importL > previewL + previewW - importW ){
					importL = previewL + previewW - importW;
				}
				importArea.style.left = ( importL + canvImage.offsetLeft -2 ) + 'px';
				importImageArea();
				imgImportData = ctx.getImageData(0,0,24,inFrames.value);
				break;
		}
		canvImportV.style.width = importArea.style.width;
		canvImportV.style.height = importArea.style.height;
		importImageToMatrix();

	}

	function imageMouseMove( objEvent ){
		if( imgImport == null ){ return; }
		switch(scanAspect){
			case 0: var sTop = inFrames.value / previewW * objEvent.layerX; break;
			case 1: var sTop = inFrames.value / previewH * objEvent.layerY; break;
		}
		divImageFrames.scrollTop = sTop * 15 - divImageFrames.offsetHeight / 2;
	}

	function sliderImportInput( obj ){
		if( imgImport == null ){ obj.value = 0; return; }
		sliderImportActivate( obj );
	}

	function sliderImportWheel( obj, event ){
		if( imgImport == null ){ obj.value = 0; return; }
		if( event.deltaY < 0 ){
			obj.stepUp(1);
		} else if( event.deltaY > 0 ){
			obj.stepDown(1);
		}
		sliderImportActivate( obj );
	}

	function sliderImportDouble( obj ){
		if( imgImport == null ){ obj.value = 0; return; }
		obj.value = 0;
		sliderImportActivate( obj );
	}

	function sliderImportActivate( obj ){
		switch( obj.id ){
			case 'sliderDimmer':
				var xVal = Math.round( obj.value * 100 );
				break;

			case 'sliderHue':
				var xVal = Math.round( obj.value * 360 ) + '&deg;';
				break;

			case 'sliderSaturation':
				var xVal = Math.round( obj.value * 100 );
				break;

			case 'sliderLightness':
				var xVal = Math.round( obj.value * 200 );
				break;

			case 'sliderZoom':
				var xVal = ( Math.round( (100 - obj.value * 100) * 100) / 100 ) + '%';
				break;
		}
		document.getElementById( obj.id + 'Val').innerHTML = xVal;
		if( obj.id == 'sliderZoom'){
			setupImportArea();
			refreshImageData();
		}
		importImageToMatrix();
	}

	function closeImport( obj ){
		switch( obj.id ){
			case 'but_import_accept':
				importImageToFrames();
				showAnimationTime();
				break;
		}
		document.getElementById('imageImporter').style.visibility = 'hidden';
		document.getElementById('editor').style.visibility = 'visible';
		clearInterval(blinkInterval);
	}

	function closeExport( obj ){
		document.getElementById('imageExporter').style.visibility = 'hidden';
		document.getElementById('editor').style.visibility = 'visible';
	}

// ******************** End Image import ********************


		var aniIndex = [];
		function openAnimationIndex(){
			// get stored animation index
			aniIndex = [];
			Homey.get('aniIndex', function( err, aIndex ){
				if ( aIndex == undefined ){
					// create empty memory slots
					valFPS = 1; valTFPS = 60; valRPM = 0; ledFrames = [ emptyFrame ];
					var aIndex = [];
					for( var i=0; i<30; i++ ){
						aIndex.push( { name: ('Animation ' + (i+1)) } );
						saveAnimation(i);
					}
					aniIndex = [].concat(aIndex);
					storeAniIndex();
				} else {
					aniIndex = [].concat(aIndex);
				}

				var xOptions = '';
				for( var i=0; i<30; i++){
					xOptions += '<option value="ani_' + i + '">' + (i+1) + ': ' + aniIndex[i].name + '</option>';
				}
				dropAnimation.innerHTML = xOptions;
				dropAnimation.selectedIndex = selectedAnimation;
			});
		}

		function storeAniIndex(){
			// store animation index
			Homey.set('aniIndex', aniIndex, function(err, aniIndex){
				if( err ) return console.error('Could not set '+aniId, err);
			});
		}

		function changeAniName( obj ){
			xName = obj.value;
			for( var i=0; i < xName.length; i++){
				var checkCode = xName.charCodeAt(i);
				var checkChar = xName.charAt(i);
				if( checkCode < 32 || checkCode > 126  || checkCode == 34 || checkCode == 39 ){ // not allowed
					xName = xName.substr(0, i) + xName.substr(i+1);
					obj.value = xName;
				}
			}
		}

		function saveAnimation(id){
			if( id == undefined ){
				id = selectedAnimation;
			}
			if( id == '' ){
				var xRepeat = document.getElementById('inRepeat').value;
			} else {
				var xRepeat = 1;
			}
			var	aniId = 'animation' + id,
				aniDuration = xRepeat * Math.round( 1000 * ledFrames.length / valFPS);

			var saveAni = {
				options: {
				fps     : valFPS, 		// animation frames per second
				tfps    : valTFPS, 		// view frames per second. every second will be interpolated valTFPS times
				rpm     : valRPM,		// ring rotations per minute
				},
				frames	: ledFrames,
				priority: 'INFORMATIVE',	// CRITICAL, FEEDBACK or INFORMATIVE
				duration: aniDuration		// duration in ms, or keep empty for infinite
			}
			Homey.set( aniId, saveAni, function(err, animation){
				if( err ) return console.error('Could not set '+aniId, err);
			});
		}
		
		function openAnimation(id){
			if( id == undefined ){ id = selectedAnimation; }
			var aniId = 'animation' + id;
			playFrame = 0;

			Homey.get(aniId, function(err, ani){
				if ( ani == undefined ){
					var newFrame = [];
					var newFrames = [];
					for(var i=0; i<24; i++){
						newFrame.push( { r:0, g:0, b:0 } );
					}
					newFrames.push( newFrame );
					ani = {
						frames: newFrames,
						options: {
							fps: 1,
							tfps: 60,
							rpm: 0
						}
					}
				}

				ledFrames = [].concat(ani.frames);
				refreshCounter(); // reset
				refreshCounter( ledFrames.length );

				valFPS = ani.options.fps;
				valTFPS = ani.options.tfps;
				valRPM = ani.options.rpm;

				document.getElementById('inRPM').value = valRPM;
				document.getElementById('inFPS').value = valFPS;
				document.getElementById('inTFPS').value = valTFPS;

				if (count_frames == 0) { addNewFrame(); } // Always add at least one frame
				selectedFrame = 0;
				ledFrame = [].concat(ledFrames[ selectedFrame ] );

				refreshFramesList();
				refreshLedSelectors();
				drawLedRing();
				drawAllFramePreviews();
				showAnimationTime();

				if( enableAniCopy ){
					saveAnimation( selectedAnimation );
					dropAnimation.value = 'ani_'+selectedAnimation;
					actionUndo();
					clickAniCopy();
				} else {
					undoList = []; undoPointer = -1; actionUndo();
				}
				refreshButtons();
			});
		}

		function selectAnimation( obj ){
			var id = Number(obj.value.substr(4));
			if( id != selectedAnimation ){
				if( enableAniCopy ){
					openAnimation(id);
				} else {
					saveAnimation( selectedAnimation );
					selectedAnimation = id;
					openAnimation();
				}
				butCopyAni.title = txt_ani_copy.replace('###', selectedAnimation+1);
			}
		}

		function showAnimationTime(){
			var aniDuration = ledFrames.length / valFPS;
			var repeatDuration = aniDuration * inRepeat.value;
			var m = Math.floor( repeatDuration / 60 ).toString();
			var s = Math.round( repeatDuration - Math.floor( repeatDuration / 60 ) * 60 ).toString();
			if( m.length <2 ){ m = '0' + m; }
			if( s.length <2 ){ s = '0' + s; }
			document.getElementById('aniTime').innerHTML = ' = ' + aniDuration.toFixed(2) + ' sec.';
			document.getElementById('repeatTime').innerHTML = '= ' + m + ':' + s;
		}

		enableAniCopy = false;
		function clickAniCopy(){
			enableAniCopy = !enableAniCopy;
			if( enableAniCopy ){
				butRenameAni.disabled = true;
				butCopyAni.style.backgroundColor = '#ffe0e0';
				dropAnimation.style.backgroundColor = '#ffe0e0';
			} else {
				butRenameAni.disabled = false;
				butCopyAni.style.backgroundColor = '#eeeeee';
				dropAnimation.style.backgroundColor = '#eeeeee';
			}
		}

		enableAniRename = false;
		function clickAniRename(){
			enableAniRename = !enableAniRename;
			if( enableAniRename ){
				butCopyAni.disabled = true;
				dropAnimation.disabled = true;
				butRenameAni.style.backgroundColor = '#e0ffe0';
				inName.style.visibility = 'visible';
				inName.value = aniIndex[selectedAnimation].name;
			} else {
				aniIndex[selectedAnimation] = { name: inName.value };
				storeAniIndex();
				openAnimationIndex();
				butCopyAni.disabled = false;
				dropAnimation.disabled = false;
				butRenameAni.style.backgroundColor = '#eeeeee';
				inName.style.visibility = 'hidden';
			}
		}







		function getFrameListRow(idx, titRemove){
			var xCol = getTopColor();
			trLine = '<tr id="frameLine' + idx + '" style="background-color:' + xCol.b + '; color:' + xCol.t + '; border: 1px solid #707070;" onmouseover="showFrameControls(this);" onmouseout="hideFrameControls(this);" onClick="frameSelect(this);">';
			trLine += '<td style="width: 30px; text-align: center; font-size: 14px;">' + (idx+1) + '</td>';
			trLine += '<td style="width: 240px;"><canvas id="canvPre' + idx + '" width=240 height=30></canvas></td>';
			trLine += '<td style="width: 10px;"></td>';
			trLine += '<td style="width: 20px;">';
			if( idx > 0 ){
				trLine += '<button id="moveUp' + idx + '" style="visibility: hidden; width:20px; height:20px; padding: 0px 0px;" title="' + txtMoveUp + '" onmousedown="clickFrameMove(this);"><img src="../assets/images/frame_up.png" height="16" width="16" style="float: center;"></button>';
			}
			trLine += '</td>';

			trLine += '<td style="width: 20px;">';
			if( idx < ledFrames.length-1 ){
				trLine += '<button id="moveDown' + idx + '" style="visibility: hidden; width:20px; height:20px; padding: 0px 0px;" title="' + txtMoveDown + '" onmousedown="clickFrameMove(this);"><img src="../assets/images/frame_down.png" height="16" width="16" style="float: center;"></button>';
			}
			trLine += '</td>';

			trLine += '<td style="width: 20px;"></td>';
			trLine += '<td style="width: 20px;"><button id="rem' + idx + '" style="visibility: hidden; width:20px; height:20px; padding: 0px 0px;" title="' + titRemove + '" onmouseover="this.style.backgroundColor =\'#f44336\';" onmouseout="this.style.backgroundColor=\'#eeeeee\';" onclick="removeFrame(this);"><img src="../assets/images/frame_delete.png" height="16" width="16" style="float: center;"></button></td>';
			
			trLine += '<td></td>';
			trLine += '</tr>';
			return ( trLine );
		}

		function showFrameControls( obj ){
			xId = Number(obj.id.substr(9));
			if( xId > 0 ){ document.getElementById( 'moveUp' + xId ).style.visibility = 'visible'; }
			if( xId < ledFrames.length-1 ){ document.getElementById( 'moveDown' + xId ).style.visibility = 'visible'; }
			document.getElementById( 'rem' + xId ).style.visibility = 'visible';
		}

		function hideFrameControls( obj ){
			xId = Number(obj.id.substr(9));
			if( xId > 0 ){ document.getElementById( 'moveUp' + xId ).style.visibility = 'hidden'; }
			if( xId < ledFrames.length-1 ){ document.getElementById( 'moveDown' + xId ).style.visibility = 'hidden'; }
			document.getElementById( 'rem' + xId ).style.visibility = 'hidden';
		}

		function clickFrameMove( obj ){
			var xId = obj.id;
			var newFrames = [];
			if( xId.substr(0,6) == 'moveUp' ){
				var xMove = -1;
				xId = Number(xId.substr(6));
			} else {
				var xMove = 1;
				xId = Number(xId.substr(8));
			}
			var tempFrame = [].concat( ledFrames[ xId + xMove ] );
			ledFrames[ xId + xMove ] = [].concat( ledFrames[ xId ] );
			ledFrames[ xId ] = [].concat( tempFrame );
			
			refreshFramesList();
			actionUndo();
			selectedFrame = xId + xMove;
			frameSelect({ id:'frameLine'+selectedFrame });
			divFrameScroll.scrollTop += (document.getElementById('frameLine0').offsetHeight * xMove) ;
		}


		function clickFrameEdit( obj ){
			switch( obj.id ){

			case 'but_frame_add':
			case 'but_frame_copy':
				ledFrames.splice(selectedFrame+1, 0, ledFrames[selectedFrame]);
				refreshCounter(1);
				selectedFrame += 1;
				refreshFramesList();

				if( obj.id == 'but_frame_add' ){
					for(var i=0; i<24; i++ ){
						ledFrames[ selectedFrame ][i] = { r:0, g:0, b:0 }
					}
				}
				refreshFramesList();
				actionUndo();
				divFrameScroll.scrollTop += document.getElementById('frameLine0').offsetHeight ;
				break;

			case 'but_image_import':
				document.getElementById('imageImporter').style.visibility = 'visible';
				document.getElementById('editor').style.visibility = 'hidden';
				blinkInterval = setInterval(function(){
					var xT = Math.floor( new Date().getMilliseconds() / 500 );
					switch( xT ){
						case 0: importArea.style.borderColor = "#ffffff"; break;
						case 1: importArea.style.borderColor = "#000000"; break;
					}
				}, 500);
				break;

			case 'but_image_export':
				var ctxExport = canvImageExport.getContext("2d");
				document.getElementById('imageExporter').style.visibility = 'visible';
				canvImageExport.width = 200;
				canvImageExport.height = 24;
				var stepW = 1;
				ctxExport.fillStyle = '#000000';
				ctxExport.fillRect( 0, 0, canvImageExport.width, canvImageExport.height);
				for( var x = 0; x < ledFrames.length; x ++ ){
					for( var y = 0; y < 24; y ++ ){
						ctxExport.fillStyle = 'rgba( ' + ledFrames[x][y].r + ',' + ledFrames[x][y].g + ',' + ledFrames[x][y].b + ',' + ' 1 )';
						var yLed = y - 9; if( yLed < 0 ){ yLed +=24; }
						ctxExport.fillRect(x * stepW, yLed, stepW, 1);
					}
				}
				document.getElementById('editor').style.visibility = 'hidden';
				break;

			case 'but_frame_clock':
				var newFrame = [];
				for(var i = 0; i<24; i++ ){
					var xIndex = i + 1; if( xIndex>23 ){ xIndex -= 24;}
					newFrame[xIndex] = ledFrames[selectedFrame][i];
				}
				ledFrames[selectedFrame] = newFrame.splice(0);
				refreshFramesList();
				actionUndo();
				break;


			case 'but_frame_counterclock':
				var newFrame = [];
				for(var i = 0; i<24; i++ ){
					var xIndex = i - 1; if( xIndex<0 ){ xIndex += 24;}
					newFrame[xIndex] = ledFrames[selectedFrame][i];
				}
				ledFrames[selectedFrame] = newFrame.splice(0);
				refreshFramesList();
				actionUndo();
				break;

			case 'but_frame_push':
				var newFrame = [];
				for(var i = 0; i<24; i++ ){

					if(i == 9 || i == 21 ){
						newFrame[i] = ledFrames[selectedFrame][i];
					} else if ( i>21 || i<9 ){
						var xIndex = i + 1; 
						if( xIndex > 23 ){ xIndex -= 24;}
						if( xIndex == 9 ){ xIndex = 22;}
						newFrame[xIndex] = ledFrames[selectedFrame][i];

					} else if ( i>9 && i<21){
						var xIndex = i - 1;
						if( xIndex == 9 ){ xIndex = 20;}
						newFrame[xIndex] = ledFrames[selectedFrame][i];
					}
				}
				ledFrames[selectedFrame] = newFrame.splice(0);
				refreshFramesList();
				actionUndo();
				break;

			case 'but_frame_pull':
				var newFrame = [];
				for(var i = 0; i<24; i++ ){

					if(i == 9 || i == 21 ){
						newFrame[i] = ledFrames[selectedFrame][i];
					} else if ( i>21 || i<9 ){
						var xIndex = i - 1; 
						if( xIndex<0 ){ xIndex += 24;}
						if( xIndex == 21 ){ xIndex = 8;}
						newFrame[xIndex] = ledFrames[selectedFrame][i];

					} else if ( i>9 && i<21){
						var xIndex = i + 1;
						if( xIndex == 21 ){ xIndex = 10;}
						newFrame[xIndex] = ledFrames[selectedFrame][i];
					}
				}
				ledFrames[selectedFrame] = newFrame.splice(0);
				refreshFramesList();
				actionUndo();
				break;
			}
		}
		
		function addNewFrame() {
			var newFrame = [];
			for(var i=0; i<24; i++){
				newFrame.push( { r:0, g:0, b:0 } );
			}
			ledFrames.push( newFrame );
			refreshCounter(1);
			selectedFrame = ledFrames.length-1;
			refreshFramesList();
		}

		function removeFrame( obj ){
			var id = obj.id;
			selectedFrame = Number(id.substr(3));
			ledFrames.splice(selectedFrame, 1);
			refreshCounter(-1);
			if( ledFrames.length == 0 ){
				addNewFrame();
			} else {
				if( selectedFrame >= ledFrames.length ){
					selectedFrame = ledFrames.length - 1;
				}
				refreshFramesList();
			}
			actionUndo();
		}

		function frameSelect( obj ){
			if( document.getElementById( obj.id ) == undefined ){ return; }
			var idx = obj.id;
			selectedFrame = Number(idx.substr(9));
			activateSelect();
		}

		function activateSelect(){
			var xCol = getTopColor();

			for( var i = 0; i < ledFrames.length; i++ ){
				var xElement = document.getElementById('frameLine' + i);
				if( i == selectedFrame ){
					document.getElementById('frameLine' + i).style.backgroundColor = '#808080';
					document.getElementById('frameLine' + i).style.color = xCol.t;
				} else {
					document.getElementById('frameLine' + i).style.backgroundColor = xCol.b;
					document.getElementById('frameLine' + i).style.color = xCol.t;
				}
			}
			ledFrame = [].concat(ledFrames[selectedFrame]);
			refreshLedSelectors();
			refreshFrameNr( selectedFrame + 1 );
			drawLedRing();
			butAddFrame.title = txt_frame_add.replace( '###', selectedFrame+1 );
			butCopyFrame.title = txt_frame_copy.replace( '###', selectedFrame+1 );
			refreshButtons();
		}

		function refreshFramesList(){
			divFrameScroll.style.backgroundColor = getTopColor().b;
			var tempDoc = '';
			ledFrames.forEach(function(item, index){
				xFrame = ledFrames[index];
				tempDoc = tempDoc + getFrameListRow( index, getTooltip('frame', index + 1) );
			});
			docFrames.innerHTML = tempDoc;
			drawAllFramePreviews();
			activateSelect();
		}

		function refreshFrameNr( nr ){
			nrFrame.innerHTML = 'Frame: ' + nr;
		}


		function drawFramePreview(idx){
			if( ledFrames[idx] != undefined && selectedFrame>=0 ){
				var	canvPrev = document.getElementById('canvPre'+idx),
					ctxPrev = canvPrev.getContext("2d"),
					canvH = canvPrev.height,
					colW = canvPrev.width/24,
					xCol = getTopColor();
				
				ctxPrev.clearRect(0, 0, canvPrev.width, canvH );
					
				ledFrames[idx].forEach(function(item, index){
					var vColor = getViewColor( item );
					if( vColor.r == 0 && vColor.g == 0 && vColor.b == 0 ){
						var colH = canvH/4;
					} else {
						var colH = canvH/2;
					}
					var colH = canvH/2;
					var xPos = 8-index; if( xPos < 0 ){ xPos += 24; }
					ctxPrev.fillStyle = 'rgba(' + vColor.r + ',' + vColor.g + ',' + vColor.b + ',1 )';
					ctxPrev.strokeStyle = xCol.t;
					ctxPrev.lineWidth = 0.5;
					switch(index){
					case 9:
						ctxPrev.strokeRect( 0, canvH*0.85 , 0, canvH*0.2 );
						ctxPrev.fillRect( -colW/2, canvH / 2 - colH / 2, colW, colH );
						ctxPrev.strokeStyle = "#808080";
						ctxPrev.strokeRect( -colW/2, canvH / 2 - colH / 2, colW, colH );
					default:
						if( Math.floor( (index+3) / 6 ) * 6 == index+3 ){
							ctxPrev.strokeRect(xPos * colW + colW, canvH*0.85 , 1, canvH*0.2 );
						} else {
							ctxPrev.strokeRect(xPos * colW + colW, canvH*0.9 , 0, canvH*0.1 );
						}
						ctxPrev.fillRect(xPos * colW + colW/2, canvH / 2 - colH / 2, colW, colH );
						ctxPrev.strokeStyle = "#808080";
						ctxPrev.strokeRect(xPos * colW + colW/2, canvH / 2 - colH / 2, colW, colH );
					}
				});
			}
		}
		
		function drawAllFramePreviews(){
			for( var i = 0; i < ledFrames.length; i++ ){
				drawFramePreview(i);
			}
		}

		function getTooltip(txt, nr){
			return (txtRemove + ':\n' + txt + ' ... ' + nr);
		}

		function refreshCounter(stepVal){
		// list items counter.
		// <stepVal> = count_frames change.
		// <stepVal> = undefined --> reset: set count_frames = 0

			if(stepVal == undefined){ 
				count_frames = 0;
			} else{
				count_frames += stepVal;
			}
			refreshButtons();
			xDoc = document.getElementById("frameCount");
			var xCount = count_frames + ' frame';
			if( count_frames > 1 ){ xCount += 's'; }
			xDoc.innerHTML = xCount;
			showAnimationTime();
		}

		function drawLedRing(){
			ctxDraw = canvRing.getContext("2d");
			
			var	ringRadius = caseRadius * 1.05,
				ledSize = Math.PI * ringRadius / 24, // ( Pi * r) / number of leds
				ledFactor = ledSize / ledW;

			canvRing.style.filter = 'blur(' + ledSize*0.3 + 'px)';
			canvRing2.style.filter = 'blur(' + ledSize*0.3 + 'px)';

			var alpha = 0;
			for( var i=0; i<24; i++){
				var cR = Number(ledFrame[i].r);
				var cG = Number(ledFrame[i].g);
				var cB = Number(ledFrame[i].b);
				if( cR>0 || cG>0 || cB>0 ){ alpha ++; }
			}
			if( alpha > 0 ){ alpha = 0.15/alpha; }

			ctxDraw.shadowBlur = 0;
			ctxDraw.clearRect( 0, 0, editW, editW );

			// draw leds
			ctxDraw.globalCompositeOperation='lighter';
			for( var i=0; i<24; i++){
				var codeRGB = ledFrame[i].r + ',' + ledFrame[i].g + ',' + ledFrame[i].b;
					
				if(codeRGB != '0,0,0'){
					var cView = getViewColor(ledFrame[i]);

					cR = Number(cView.r);
					cG = Number(cView.g);
					cB = Number(cView.b);
					if( cR>=cG && cR>=cB ){
						cMultiply = 255/cR;
						cBright = cR/255;
					} else if( cG>=cB ){
						cMultiply = 255/cG;
						cBright = cG/255;
					} else {
						cMultiply = 255/cB;
						cBright = cB/255;
					}

					var brightness = (cR + cG + cB) / 255;
					if( brightness <= 1 ){
						brightness = brightness;
					} else {
						brightness = 1 - (( brightness -1 ) / 2 );
					}
					brightness = brightness * 0.3;

					cR = Math.round( Number( cView.r ) * cMultiply ); if( cR > 255 ){ cR = 255; }
					cG = Math.round( Number( cView.g ) * cMultiply ); if( cG > 255 ){ cG = 255; }
					cB = Math.round( Number( cView.b ) * cMultiply ); if( cB > 255 ){ cB = 255; }
					var codeRGBview = cR + ',' + cG + ',' + cB;
					
					var angle = (i+9) * 2 * Math.PI / 24, cos = Math.cos(angle), sin = Math.sin(angle);
					var xPos = editW2 + ringRadius * cos;
					var yPos = editW2 + ringRadius * sin;

					var grd = ctxDraw.createRadialGradient(xPos, yPos, 0, xPos, yPos, ledW);
					grd.addColorStop( 0  , 'rgba('+ codeRGBview + ',' + (0.7 + cBright * 0.3) + ')' );
					grd.addColorStop( ledFactor * 0.5,'rgba('+ codeRGBview + ',' + (cBright) + ')' );
					grd.addColorStop( ledFactor * 1.0,'rgba('+ codeRGBview + ',' + (cBright*0.9) + ')' );
					grd.addColorStop( ledFactor * 1.2,'rgba('+ codeRGBview + ',' + alpha + ')' );
					grd.addColorStop( 1  , 'rgba('+ codeRGBview + ',' + alpha + ')' );
					ctxDraw.fillStyle = grd;
					ctxDraw.beginPath();
					ctxDraw.arc( xPos, yPos, ledW+1, 0, 2 * Math.PI );
					ctxDraw.fill();
					
					// center brightness
					var grd = ctxDraw.createRadialGradient(xPos, yPos, 0, xPos, yPos, ledW);
					grd.addColorStop( 0  , 'rgba( 255, 255, 255,' + (brightness) + ')' );
					grd.addColorStop(  ledFactor * 0.5  , 'rgba('+ codeRGBview + ',' + (brightness * 0.7) + ')' );
					grd.addColorStop(  ledFactor * 1  , 'rgba('+ codeRGBview + ', 0 )' );
					grd.addColorStop( 1  , 'rgba('+ codeRGBview + ', 0)' );
					ctxDraw.fillStyle = grd;
					ctxDraw.beginPath();
					ctxDraw.arc( xPos, yPos, ledSize, 0, 2 * Math.PI );
					ctxDraw.fill();
				}
			}

			// ring radiation
			ctxDraw.globalCompositeOperation='destination-over';
			for( var i=0; i<24; i++){
				var codeRGB = ledFrame[i].r + ',' + ledFrame[i].g + ',' + ledFrame[i].b;
					
				if(codeRGB != '0,0,0'){
					var cView = getViewColor(ledFrame[i]);

					cR = Number(cView.r);
					cG = Number(cView.g);
					cB = Number(cView.b);
					if( cR>=cG && cR>=cB ){
						cMultiply = 255/cR;
						cBright = cR/255;
					} else if( cG>=cB ){
						cMultiply = 255/cG;
						cBright = cG/255;
					} else {
						cMultiply = 255/cB;
						cBright = cB/255;
					}

					cR = Math.round( Number( cView.r ) * cMultiply ); if( cR > 255 ){ cR = 255; }
					cG = Math.round( Number( cView.g ) * cMultiply ); if( cG > 255 ){ cG = 255; }
					cB = Math.round( Number( cView.b ) * cMultiply ); if( cB > 255 ){ cB = 255; }
					var codeRGBview = cR + ',' + cG + ',' + cB;
					
					var angle = (i+9) * 2 * Math.PI / 24, cos = Math.cos(angle), sin = Math.sin(angle);
					var xPos = editW2 + ringRadius * cos;
					var yPos = editW2 + ringRadius * sin;
					var grd = ctxDraw.createRadialGradient(xPos, yPos, 0, xPos, yPos, ledSize * 5);
					grd.addColorStop( 0, 'rgba('+ codeRGBview + ',' + (cBright * 0.9) + ')' );
					grd.addColorStop( 1, 'rgba('+ codeRGBview + ',' + alpha + ')' );

					ctxDraw.fillStyle = grd;
					ctxDraw.beginPath();
					ctxDraw.arc( xPos, yPos, ledW+1, 0, 2 * Math.PI );
					ctxDraw.fill();
				}
			}

			// background
			ctxDraw.globalCompositeOperation='destination-over';
			ctxDraw.fillStyle = '#000000';
			ctxDraw.fillRect( 0, 0, editW, editW );
		}


		function drawTop(){
			var	xCol = getTopColor(),
				cR = parseInt(xCol.b.substr(1,2), 16),
				cG = parseInt(xCol.b.substr(3,2), 16),
				cB = parseInt(xCol.b.substr(5,2), 16);

			txtLedRing.style.color = xCol.t;
			nrFrame.style.color = xCol.t;

			ctxTop.clearRect(0,0,editW,editW);
			// draw case
			var grd = ctxTop.createRadialGradient(editW2, editW2, 0, editW2, editW2, caseRadius);
			grd.addColorStop( 0  , 'rgba( 255, 255, 255, 1 )' );
			grd.addColorStop( 0.9, 'rgba( 136, 136, 136, 1 )' );
			grd.addColorStop( 1  , 'rgba( 128, 128, 128, 0.8 )' );
			ctxTop.fillStyle = grd;
			ctxTop.beginPath();
			ctxTop.arc( editW2, editW2, caseRadius, 0, 2 * Math.PI );
			ctxTop.fill();

			// cut ring
			var grd = ctxTop.createRadialGradient(editW2, editW2, 1, editW2, editW2, editW2);
			grd.addColorStop( 0   , 'rgba(' + cR + ', ' + cG + ', ' + cB + ', 0)' );
			grd.addColorStop( 0.94 , 'rgba(' + cR + ', ' + cG + ', ' + cB + ', 0)' );
			grd.addColorStop( 0.942 , 'rgba(' + cR + ', ' + cG + ', ' + cB + ', 1)' );
			grd.addColorStop( 1   , 'rgba(' + cR + ', ' + cG + ', ' + cB + ', 1)' );
			ctxTop.fillStyle = grd;
			ctxTop.fillRect(0,0,editW,editW);
		}

		function changeTopColor(){
			topColor ++;
			if( topColor > 3 ){ topColor = 0; }
			Homey.set( 'topColor', topColor, function(err, topColor){
				if( err ) return console.error('Could not set topColor');
			});
			drawTop();
			refreshFramesList();
		}

		function getTopColor(){
			switch(topColor){ // colTop = 0...3 (black, 33% grey, 67% grey, white)
				case 0: var bB = '#000000', bT = '#ffffff'; break;
				case 1: var bB = '#555555', bT = '#ffffff'; break;
				case 2: var bB = '#aaaaaa', bT = '#000000'; break;
				default: var bB = '#ffffff', bT = '#000000'; break;
			}
			return { b:bB, t:bT };
		}
		

		var borderMarkerW = 2;
		function refreshLedSelectors(){
			for( var i=0; i<24; i++){

				var	angle = (i+9) * 2 * Math.PI / 24,
					cos = Math.cos(angle),
					sin = Math.sin(angle),
					rgbLED = ledFrame[i].r + ',' + ledFrame[i].g + ',' + ledFrame[i].b,
					rgbView = getViewColor(ledFrame[i]).r + ',' + getViewColor(ledFrame[i]).g + ',' + getViewColor(ledFrame[i]).b,
					rgbSelected = colPal[selectedColor].r+','+colPal[selectedColor].g+','+colPal[selectedColor].b;

				colX = document.getElementById('ledMarker'+i);
				xPos = editW2 + (caseRadius - ledEditW - 8) * cos;
				yPos = editW2 + (caseRadius - ledEditW - 8) * sin;
				colX.style.left = (xPos - ledEditW/2 - borderMarkerW) + 'px';
				colX.style.top = (yPos - ledEditW/2 - borderMarkerW) + 'px';
				colX.style.width = ledEditW + 'px';
				colX.style.height = ledEditW + 'px';
				colX.style.backgroundColor = 'rgba('+ rgbView + ', 1)';
				colX.style.textAlign = 'center';
				colX.style.margin = '0px 0px 0px 0px';
				colX.style.lineHeight = ledEditW + 'px';
				colX.style.verticalAlign = 'middle';
				colX.style.border = borderMarkerW + 'px solid rgba(127,127,127,0)';
				colNr = i+4; if( colNr>24 ){ colNr -=24;}
				colX.innerHTML = colNr;

				if( rgbLED == '0,0,0'){
					colX.style.color = 'rgba( 255,127,127, 1)';
				} else {
					xCol = contrastBlackOrWhite( ledFrame[i] );
					colX.style.color = 'rgba(' + xCol.r + ',' + xCol.g + ',' + xCol.b + ',1)';
/*
					var rgbAdd = Number(ledFrame[i].r) + 2*Number(ledFrame[i].g) + 0.3 * Number(ledFrame[i].b);
					if( rgbAdd > 384 ){
						colX.style.color = 'rgba(0,0,0,1)';
					} else {
						colX.style.color = 'rgba(255,255,255,1)';
					}
*/
				}

				if( (rgbSelected) == '0,0,0'){
					colX.title = ''; //'Switch LED off';
				} else {
					colX.title = ''; //'Colorize';
				}
			}
		}

		function changeNumberSetting( obj ){
			var 	xVal = Number(obj.value),
				vMin = Number(obj.min),
				vMax = Number(obj.max);

			if( xVal < vMin ){ xVal = vMin; } else if( xVal > vMax ){ xVal = vMax; }
			switch(obj.id ){
				case'inFPS':
					if( xVal > valTFPS ){ xVal = valTFPS; }
					valFPS = xVal;
					obj.value = valFPS;
					showAnimationTime();
					prevFramePulse = 0;
					opacMs = 1 / (1000 / xVal);
					break;

				case'inTFPS':
					if( xVal < valFPS ){
						xVal = valFPS;
					}
					valTFPS = xVal;
					obj.value = valTFPS;
					break;

				case'inRPM':
					valRPM = xVal;
					rotateMs = valRPM * 360 / 60000;
					break;

				case'inRepeat':
					showAnimationTime();
					break;

				case'inFrames':
					obj.value = xVal;
					if(imgImport != null ){
						setupImportArea();
						refreshImageData();
					}
					break;
			}
		}

		function enterName( obj ){
			xName = obj.value;
			aniIndex[ selectedAnimation ] = xName;
		}



// ************** ANIMATION ENGINE **************
		var playPrevMode = false;
		var previewPlayTimer = null;
		function  clickPrev(obj){
			playPrevMode = !playPrevMode;

			if( playPrevMode ){	// play preview
				butPreview.innerHTML = '<img src="../assets/images/homey_working.png" height="30" width="30" style="float: center;">';
				var tLoad = ledFrames.length * 15; // wait 15ms for each frame to upload.
				var tDuration = Math.ceil( ledFrames.length / inFPS.value * 1000 * inRepeat.value );

				setTimeout( function(){ // wait 0.5 sec for icon to change to 'working'.
					setTimeout( function(){
						butPreview.innerHTML = '<img src="../assets/images/homey_stop.png" height="30" width="30" style="float: center;">';

						previewPlayTimer = setTimeout( function(){ // wait animation duration.
							clickPrev( butPreview );

						},  ( tDuration ) );
					},  ( tLoad ) );
					saveAnimation('');

				}, 500);

			} else {		// stop preview
				clearTimeout( previewPlayTimer );
				var saveAni = { // create animation of 1 empty frame
					options: {
						fps     : 30,
						tfps    : 60,
						rpm     : 0,
					},
					frames	: [ emptyFrame ],
					priority: 'INFORMATIVE',
					duration: 10	// duration in ms
				}
				Homey.set( 'animation', saveAni, function(err, animation){
					if( err ) return console.error('Could not set '+aniId, err);	
					butPreview.innerHTML = '<img src="../assets/images/homey_play.png" height="30" width="30" style="float: center;">';
					butPreview.title = 'Missing title';
				});
			}
		}

		var	frameID = 0,
			playFrame = 0,
			animationFilm = [],
			prevFramePulse = 0,
			opacMs = 1,
			opacStartTime = 0,
			rotateMs = 0,
			rotateStartTime = 0;


		function  clickPlay(obj){
			playMode = !playMode;
			if( playMode ){
				saveAnimation( selectedAnimation );
				obj.innerHTML = '<img src="../assets/images/ani_working.png" height="30" width="30" style="float: center;">';
					
				setTimeout( function(){
					obj.innerHTML = '<img src="../assets/images/ani_stop.png" height="30" width="30" style="float: center;">';
					rotateStartTime = new Date().getTime();
					createAnimationFilm();
					playFrame = 0;
					frameID = requestAnimationFrame(runAnimation);
				}, 500)
				divEdit.style.visibility = "hidden";

				canvRing2.style.transitionTimingFunction = 'linear';
				canvRing2.style.transitionDuration = '0ms';
				refreshButtons(false);


			} else {
				cancelAnimationFrame(frameID);
				obj.innerHTML = '<img src="../assets/images/ani_play.png" height="30" width="30" style="float: center;">';
				divEdit.style.visibility = "visible";

				divRing.style.transform = 'rotate(0deg)';
				refreshButtons();
				canvRing.style.opacity = 1;
				canvRing2.style.opacity = 0;
				activateSelect();
			}
		}


		// requestAnimationFrame polyfill by Erik Möller (Opera).
		// fixes from Paul Irish (Google) and Tino Zijdel (Tweakers.net).
		(function() {
			var lastTime = 0;
			var vendors = ['ms', 'moz', 'webkit', 'o'];
			for(var x = 0; x < vendors.length && !window.requestAnimationFrame; x++) {
				window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
				window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
					|| window[vendors[x]+'CancelRequestAnimationFrame'];
			}
 
			if (!window.requestAnimationFrame)
				window.requestAnimationFrame = function(callback, element) {
				var currTime = new Date().getTime();
				var timeToCall = Math.max(0, 16 - (currTime - lastTime));
				var id = window.setTimeout(function() { callback(currTime + timeToCall); },
					timeToCall);
				lastTime = currTime + timeToCall;
				return id;
			};
 
			if (!window.cancelAnimationFrame)
				window.cancelAnimationFrame = function(id) {
				clearTimeout(id);
			};
		}());


		function runAnimation(){
			setTimeout(function() {
        			if( playMode ){
					frameID = requestAnimationFrame(runAnimation);

					var	ms = new Date().getTime(),
						thisFramePulse = Math.round(ms/(1000/valFPS)),
						framePulseDif = thisFramePulse - prevFramePulse;

					// frame change
					if( framePulseDif > 0 ){
						if( framePulseDif > ledFrames.length ){
							playFrame = 0;
						} else{
							playFrame += framePulseDif;
							if( playFrame >= ledFrames.length ){
								playFrame -= ledFrames.length;
							}
						}
						refreshFrameNr( playFrame + 1 );
						prevFramePulse = thisFramePulse;
						opacStartTime = ms;
						updateAniFrame();
					}
					// canvas opacity change
					canvRing2.style.opacity = opacMs * ( ms - opacStartTime );
					var xRotate = rotateMs * ( ms - rotateStartTime )
					divRing.style.transform = 'rotate(' + xRotate + 'deg)';
				}
			}, 1000 / valTFPS);

		}
		
		function updateAniFrame(){
			opacMs = 1 / (1000 / valFPS);
			rotateMs = valRPM * 360 / 60000;
			// copy canvRing2 to canvRing
			var prevFrame = playFrame - 1; if( prevFrame < 0 ){ prevFrame += ledFrames.length; }
			ctxRing.putImageData(animationFilm[prevFrame],0,0);

			// put new frame on canvRing2
			ctxRing2.putImageData(animationFilm[playFrame],0,0);
		}

		function createAnimationFilm(){
			animationFilm = [];
			for( var i = 0; i < ledFrames.length; i++ ){
				ledFrame = ledFrames[i];
				drawLedRing();
				animationFilm[i] = ctxRing.getImageData(0,0,400,400);
			}
		}

// ************** END ANIMATION ENGINE **************


		function clickColorPalette(obj){
			selectedColor = Number( obj.id.substr(6) ); // colSet-id
			var vColor = getViewColor( colPal[selectedColor] );
			var viewCol = vColor.r + ',' + vColor.g + ',' + vColor.b;

			ledSelectPreview( vColor );
			divColorPal.style.visibility = 'hidden';
			refreshLedSelectors();
		}

		function ledSelectPreview( ledCol, ledText ){
			var	ctxCol = colPreview.getContext("2d");

			if( ledCol == '' ){ ledCol = colPal[selectedColor]; }
			if( ledText == undefined ){ ledText = ''; }

			if( dropFillType.value == 'type_3' ){
				setColPreviewFill( '' );
			} else {
				setColPreviewFill( colPal[selectedColor] );

				var compCol = ledCol.r +','+ ledCol.g +','+ ledCol.b;
				switch( compCol ){
					case '0,0,0': ledText = txt_ed_apply_off; break;
					case '255,0,0': ledText = txt_pure_red.substr( txt_pure_red.indexOf(' ') + 1 ); break;
					case '255,255,0': ledText = txt_pure_yellow.substr( txt_pure_yellow.indexOf(' ') + 1 ); break;
					case '0,255,0': ledText = txt_pure_green.substr( txt_pure_green.indexOf(' ') + 1 ); break;
					case '0,255,255': ledText = txt_pure_cyan.substr( txt_pure_cyan.indexOf(' ') + 1 ); break;
					case '0,0,255': ledText = txt_pure_blue.substr( txt_pure_blue.indexOf(' ') + 1 ); break;
					case '255,0,255': ledText = txt_pure_magenta.substr( txt_pure_magenta.indexOf(' ') + 1 ); break;
					case '255,255,255': ledText = txt_bright_white.substr( txt_bright_white.indexOf(' ') + 1 ); break;
				} 
			}
			ledText = ledText.substr(0,1).toUpperCase() + ledText.substr(1).toLowerCase();
			xCol = contrastBlackOrWhite( ledCol );
			ctxCol.textAlign = 'center';
			ctxCol.textBaseline = 'middle';
			ctxCol.font = '14px helvetica-neue, sans-serif';
			ctxCol.fillStyle = 'rgba(' + xCol.r + ',' + xCol.g + ',' + xCol.b + ',1)';
			ctxCol.fillText( ledText, colPreview.width/2, colPreview.height/2 )
		}

		function setColPreviewFill( col1, col2, nStep ){
			// col1 = undefined, col2 = undefined	: selectedColor
			// col1 = '', col2 = undefined		: full gradient
			// col1 = rgbObj, col2 = undefined	: col1
			// col1 = rgbObj, col2 = rgbObj		: gradient col1 -> col2

			var	ctxCol = colPreview.getContext("2d");

			if( col1 == undefined && col2 == undefined){
				var xCol = getViewColor( { r:colPal[selectedColor].r, g:colPal[selectedColor].g, b:colPal[selectedColor].b } );
				ctxCol.fillStyle = 'rgba('+ xCol.r + ',' + xCol.g + ',' + xCol.b +',1)';

			} else if( col2 == undefined ){
				if( col1 != '' ){
					var xCol1 = getViewColor( { r:col1.r, g:col1.g, b:col1.b } );
					ctxCol.fillStyle = 'rgba('+ xCol1.r + ',' + xCol1.g + ',' + xCol1.b +',1)';
				} else {
					var grd=ctxCol.createLinearGradient( 0, 0, colPreview.width, 0 );
					grd.addColorStop(0, "#000000");
					grd.addColorStop(1, "#ffffff");
					ctxCol.fillStyle = grd;
				}

			} else {
				var xCol1 = getViewColor( { r:col1.r, g:col1.g, b:col1.b } );
				var xCol2 = getViewColor( { r:col2.r, g:col2.g, b:col2.b } );
				if( (xCol1.r + xCol1.g + xCol1.b > 0) && ( xCol2.r + xCol2.g + xCol2.b > 0 ) ){
/*
					var stepR = ( xCol2.r - xCol1.r ) / nStep;
					var stepG = ( xCol2.g - xCol1.g ) / nStep;
					var stepB = ( xCol2.b - xCol1.b ) / nStep;

					var cR = xCol1.r;
					var cG = xCol1.g;
					var cB = xCol1.b;
*/
					var stepR = ( col2.r - col1.r ) / nStep;
					var stepG = ( col2.g - col1.g ) / nStep;
					var stepB = ( col2.b - col1.b ) / nStep;

					var cR = col1.r;
					var cG = col1.g;
					var cB = col1.b;

					var xGr = 0, stepGr = 1 / (nStep-1);
					var grd = ctxCol.createLinearGradient( 0, 0, colPreview.width, 0 );

					cR += stepR; cG += stepG; cB += stepB; xGr += stepGr;
					vCol = getViewColor( { r:cR, g:cG, b:cB } );
/*
					grd.addColorStop( 0 ,'rgba('+ Math.round(cG) + ',' + Math.round(cG) + ',' + Math.round(cB) +',1)' );

					while(Math.round(xGr*100)/100 < 1){
						grd.addColorStop(Math.round(xGr*100)/100  ,'rgba('+ Math.round(cR) + ',' + Math.round(cG) + ',' + Math.round(cB) +',1)' );
						cR += stepR; cG += stepG; cB += stepB;
						grd.addColorStop(Math.round(xGr*100)/100  ,'rgba('+ Math.round(cR) + ',' + Math.round(cG) + ',' + Math.round(cB) +',1)' );
					
						xGr += stepGr;
					}
*/
					grd.addColorStop( 0 ,'rgba('+ Math.round(vCol.r) + ',' + Math.round(vCol.g) + ',' + Math.round(vCol.b) +',1)' );

					while(Math.round(xGr*100)/100 < 1){
						vCol = getViewColor( { r:cR, g:cG, b:cB } );
						grd.addColorStop(Math.round(xGr*100)/100  ,'rgba('+ Math.round(vCol.r) + ',' + Math.round(vCol.g) + ',' + Math.round(vCol.b) +',1)' );
						cR += stepR; cG += stepG; cB += stepB;
						vCol = getViewColor( { r:cR, g:cG, b:cB } );
						grd.addColorStop(Math.round(xGr*100)/100  ,'rgba('+ Math.round(vCol.r) + ',' + Math.round(vCol.g) + ',' + Math.round(vCol.b) +',1)' );
					
						xGr += stepGr;
					}
					cR -= stepR; cG -= stepG; cB -= stepB;
					ctxCol.fillStyle = grd;
				} else {
				}
			}
			ctxCol.fillRect( 0, 0, colPreview.width, colPreview.height );
		}


		function selectEdit(obj){
			var xVal = obj.value;
			switch(obj.id){
			case 'dropFillType':
				if( xVal != valFillType ){
					valFillType = xVal;
					switch( valFillType ){
						case 'type_1':
							var dropRange = '';
							for( var i = 1; i < 25; i++ ){
								dropRange += '<option value="range_' + i + '">';
								if( i == 24 ){ var xCount = txt_count[0]; } else { var xCount = i; }

								dropRange += txt_drop_range[0].replace( '###', xCount );
								if( i > 1 && i < 24 ){ dropRange += txt_plural_s;}
								dropRange += '</option>';
							}
							document.getElementById('dropFillRange').innerHTML = dropRange;
							refreshButtons();
							ledSelectPreview('');
							break;

						case 'type_2':
							var dropRange = '';
							for( var i = 2; i < 13; i++ ){
								if( Math.floor( 24 / i ) * i == 24 ){
									var txtOption = txt_drop_range[1].replace( '###', txt_count[i] );
									dropRange += '<option value="range_' + i + '">' + txtOption + '</option>';
								}
							}
							document.getElementById('dropFillRange').innerHTML = dropRange;
							refreshButtons();
							ledSelectPreview('');
							break;

						case 'type_3':
							var dropRange = '<option value="range_0">' + txt_drop_range[2] + '</option>';
							document.getElementById('dropFillRange').innerHTML = dropRange;
							refreshButtons();
							ledSelectPreview('');
							break;
					}
				}
				break;

			case 'dropFillRange':
				if( xVal != valFillRange ){
					valFillRange = xVal;
				}
				break;
			}
		}

		function showActiveLeds( obj ){
			var xActive = false;
			blinkInterval = setInterval(function(){
				var xT = Math.floor( new Date().getMilliseconds() / 500 );
				switch( xT ){
					case 0: 
					case 2: var bCol = "#ffffff"; break;
					case 1: 
					case 3: var bCol = "#000000"; break;
				}
				for( var i=0; i<24; i++ ){
					var bStyle = document.getElementById( 'ledMarker'+i ).style.borderStyle;
					if( bStyle != 'solid' ){
						document.getElementById( 'ledMarker'+i ).style.borderColor = bCol;
						xActive = true;
					}
				}
				if( xActive ){
					lPointer.style.stroke = bCol;
					lPointer.style.visibility = 'visible';
				}
			}, 250);

			lPointer.setAttribute( 'x1', colPreview.offsetLeft + colPreview.offsetWidth/2 );
			lPointer.setAttribute( 'y1', colPreview.offsetTop + colPreview.offsetHeight/2 );
			lPointer.setAttribute( 'x2', obj.offsetLeft + obj.offsetWidth/2 );
			lPointer.setAttribute( 'y2', obj.offsetTop + obj.offsetHeight/2 );

			var id = Number(obj.id.substr(9));
			switch(dropFillType.value){
			case 'type_1':
				var rangeVal = Number(dropFillRange.value.substr(6));
				for( var i = 1; i <= rangeVal; i++ ){
					document.getElementById( 'ledMarker'+id ).style.borderColor = '#ffffff';
					document.getElementById( 'ledMarker'+id ).style.borderStyle = 'dotted';
					id ++; if( id > 23 ){ id -= 24; }
				}
				break;

			case 'type_2':
				var rangeVal = Number(dropFillRange.value.substr(6));
				var xStart = id;
				document.getElementById( 'ledMarker'+id ).style.borderColor = '#ffffff';
				document.getElementById( 'ledMarker'+id ).style.borderStyle = 'dotted';
				id += rangeVal; if( id > 23 ){ id -= 24; }
				while( id != xStart ){
					document.getElementById( 'ledMarker'+id ).style.borderColor = '#ffffff';
					document.getElementById( 'ledMarker'+id ).style.borderStyle = 'dotted';
					id += rangeVal; if( id > 23 ){ id -= 24; }
				}
				break;

			case 'type_3':
				var xLed = id;
				var ledData = [{ led:id, r:0, g:0, b:0 }, { led:id, r:0, g:0, b:0 }]; //  = [0=first led, 1=second led]

				if( ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
					xLed --; if( xLed == -1 ){ xLed = 23; }
					while( xLed != id && ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
						xLed --; if( xLed == -1 ){  xLed = 23; }
					}

					if( xLed != id ){
						ledData[0] = { led:xLed, r:ledFrame[xLed].r, g:ledFrame[xLed].g, b:ledFrame[xLed].b }
						xLed = id+1; if( xLed == 24 ){ xLed = 0; }
						while( xLed != id && ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
							xLed ++; if( xLed == 24 ){  xLed = 0; }
						}
						ledData[1] = { led:xLed, r:ledFrame[xLed].r, g:ledFrame[xLed].g, b:ledFrame[xLed].b }
					}

					if( ledData[0].led != id ){
						var lStart = ledData[0].led +1; if( lStart == 24 ){  lStart = 0; }
						var lEnd   = ledData[1].led -1; if( lEnd == -1 ){  lEnd = 23; }
						xLed = lStart;
						document.getElementById( 'ledMarker'+ xLed ).style.borderColor = '#ffffff';
						document.getElementById( 'ledMarker'+ xLed ).style.borderStyle = 'dotted';
						while( xLed != lEnd ){
							xLed ++; if( xLed == 24 ){  xLed = 0; } 
							document.getElementById( 'ledMarker'+ xLed).style.borderColor = '#ffffff';
							document.getElementById( 'ledMarker'+ xLed).style.borderStyle = 'dotted';
						}
					}
				}
				var nStep = ledData[1].led - ledData[0].led; 
				if( nStep <0 ){ nStep += 24; }
				
				setColPreviewFill( { r:ledData[0].r, g:ledData[0].g, b:ledData[0].b }, { r:ledData[1].r, g:ledData[1].g, b:ledData[1].b }, nStep );
				break;
			}
		}

		function resetShowActive(){
			lPointer.style.visibility = 'hidden';
			clearInterval( blinkInterval );
			for( var i = 0; i < 24; i++ ){
					document.getElementById( 'ledMarker'+i ).style.borderStyle = 'solid';
					document.getElementById( 'ledMarker'+i ).style.borderStyle = 'solid';
					document.getElementById( 'ledMarker'+i ).style.borderColor = 'rgba(127,127,127,0)';
			}
			if( dropFillType.value == 'type_3' ){ setColPreviewFill(''); }
		}

		function clickLedMarker(obj){
			var id = Number(obj.id.substr(9));

			switch(dropFillType.value){
			case 'type_1':
				var rangeVal = Number(dropFillRange.value.substr(6));
				for( var i = 1; i <= rangeVal; i++ ){
					ledFrame[id] = colPal[selectedColor];
					id ++; if( id > 23 ){ id -= 24; }
				}
				ledFrames[selectedFrame] = ledFrame.slice(0);
				actionUndo();
				break;

			case 'type_2':
				var rangeVal = Number(dropFillRange.value.substr(6));
				var xStart = id;
				ledFrame[id] = colPal[selectedColor];
				id += rangeVal; if( id > 23 ){ id -= 24; }
				while( id != xStart ){
					ledFrame[id] = colPal[selectedColor];
					id += rangeVal; if( id > 23 ){ id -= 24; }
				}
				ledFrames[selectedFrame] = ledFrame.slice(0);
				actionUndo();
				break;

			case 'type_3':
				var xLed = id;
				var ledData = [{ led:id, r:0, g:0, b:0 }, { led:id, r:0, g:0, b:0 }]; //  = [0=first led, 1=second led]
				if( ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
					xLed --; if( xLed == -1 ){ xLed = 23; }

					while( xLed != id && ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
						xLed --; if( xLed == -1 ){  xLed = 23; }
					}

					if( xLed != id ){
						ledData[0] = { led:xLed, r:ledFrame[xLed].r, g:ledFrame[xLed].g, b:ledFrame[xLed].b }
						xLed = id+1; if( xLed == 24 ){ xLed = 0; }
						while( xLed != id && ledFrame[xLed].r == 0 && ledFrame[xLed].g == 0 && ledFrame[xLed].b == 0 ){
							xLed ++; if( xLed == 24 ){  xLed = 0; }
						}
						ledData[1] = { led:xLed, r:ledFrame[xLed].r, g:ledFrame[xLed].g, b:ledFrame[xLed].b }
					}

					if( ledData[0].led != id ){
						var lStart = ledData[0].led +1; if( lStart == 24 ){  lStart = 0; }
						var lEnd   = ledData[1].led -1; if( lEnd == -1 ){  lEnd = 23; }
						if( ledData[0].led< ledData[1].led ){
							stepN = ledData[1].led - ledData[0].led;
						} else {
							stepN = ledData[1].led - ledData[0].led +24;
						}
						var stepR = (ledData[1].r - ledData[0].r) / stepN;
						var stepG = (ledData[1].g - ledData[0].g) / stepN;
						var stepB = (ledData[1].b - ledData[0].b) / stepN;

						xLed = lStart; 
						var cR = ledData[0].r + stepR;
						var cG = ledData[0].g + stepG;
						var cB = ledData[0].b + stepB;
						ledFrame[xLed] = { r:Math.round(cR), g:Math.round(cG), b:Math.round(cB) }
						while( xLed != lEnd ){
							xLed ++; if( xLed == 24 ){  xLed = 0; } 
							cR = cR + stepR;
							cG = cG + stepG;
							cB = cB + stepB;
							ledFrame[xLed] = { r:Math.round(cR), g:Math.round(cG), b:Math.round(cB) }
						}
					}
				}
				ledFrames[selectedFrame] = ledFrame.slice(0);
				actionUndo();
				break;
			}
			refreshLedSelectors();
			drawLedRing();
			drawFramePreview(selectedFrame);
			refreshButtons();
		}


		
		function clickEditButton(obj){
			switch(obj.id){
			case 'colPreview':
				if( dropFillType.value != 'type_3' ){
					divColorPal.style.visibility = 'visible'; 
				}
				break;

			case 'but_edit_fill':
				var colFill = [0,0,0];
				for( var i=0; i<48; i++ ){
					colN = i; if( colN>23 ){ colN -= 24;}
					var codeRGB = ledFrame[colN].r + ',' + ledFrame[colN].g + ',' + ledFrame[colN].b;
					if( !(codeRGB == '0,0,0') ){
						colFill = [ Number(ledFrame[colN].r), Number(ledFrame[colN].g), Number(ledFrame[colN].b)];
					} else {
						ledFrame[colN] = { r:colFill[0], g:colFill[1], b:colFill[2] }
					}
				}
				ledFrames[selectedFrame] = ledFrame.slice(0);
				actionUndo();
				break;

			case 'but_edit_flow':
				var col1 = -1, col2 = -1;
				for( var i=0; i<=48; i++ ){
					colN = i; while( colN>23 ){ colN -= 24;}
					var codeRGB = ledFrame[colN].r + ',' + ledFrame[colN].g + ',' + ledFrame[colN].b;
					if( !(codeRGB == '0,0,0') ){
						if( col2 == -1 ){
							col1 = i;
						}

						if( col2 == -2 ){
							col2 = i;
							var l1 = col1; if(l1>23){l1 -= 24;}
							var l2 = col2; if(l2>23){l2 -= 24;}
							var colR = Number(ledFrame[l1].r);
							var colG = Number(ledFrame[l1].g);
							var colB = Number(ledFrame[l1].b);
							var colStepR = (Number(ledFrame[l2].r) - colR) / (col2-col1);
							var colStepG = (Number(ledFrame[l2].g) - colG) / (col2-col1);
							var colStepB = (Number(ledFrame[l2].b) - colB) / (col2-col1);
							for( var j = col1; j<= col2; j++){
								var xj = j; while( xj>23 ){ xj -= 24; }
								ledFrame[xj] = { r:Math.round(colR), g:Math.round(colG), b:Math.round(colB) }
								colR += colStepR;
								colG += colStepG;
								colB += colStepB;
							}
							col1 = col2; col2 = -1;
						}
					} else {
						if( col1 > -1 ){ col2 = -2; }
					}
				}
				ledFrames[selectedFrame] = ledFrame.slice(0);
				actionUndo();
				break;

			case 'but_edit_undo':
				actionUndo('undo');
				break;

			case 'but_edit_redo':
				actionUndo('redo');
				break;

			}
			refreshButtons();
			refreshLedSelectors();
			drawLedRing();
			drawFramePreview(selectedFrame);
		}

		function refreshButtons(butOn){
			if( butOn == undefined ){ butOn = true; }

			// check for active leds
			var ledOnCount = 0;
			var ledColCount = 0;
			var ledCol = null;
			for( var i=0; i<24; i++ ){
				var codeRGB = ledFrame[i].r + ',' + ledFrame[i].g + ',' + ledFrame[i].b;
				if( !(codeRGB == '0,0,0') ){
					ledOnCount ++;
					if( codeRGB != ledCol ){
						ledColCount ++;
						ledCol = codeRGB;
					}
				}
			}

			butCopyAni.disabled = true;
			butRenameAni.disabled = true;
			dropAnimation.disabled = true;

			but_edit_fill.disabled = true;
			but_edit_flow.disabled = true;

			dropFillType.disabled = true;
			dropFillRange.disabled = true;

			butUndo.disabled = true;
			butRedo.disabled = true;

			butAddFrame.disabled = true;
			butCopyFrame.disabled = true;

			butClock.disabled = true;
			butCounterClock.disabled = true;
			butPush.disabled = true;
			butPull.disabled = true;

			but_image_import.disabled = true;
			but_open_image.disabled = true;
			but_import_accept.disabled = true;
			but_import_cancel.disabled = true;
			but_scan_direction.disabled = true;

			if( butOn ) {
				but_image_import.disabled = false;
				but_open_image.disabled = false;
				but_import_cancel.disabled = false;
				if( imgImport != null ){
					but_import_accept.disabled = false;
					but_scan_direction.disabled = false;
				}

				butCopyAni.disabled = false;
				butRenameAni.disabled = false;
				dropAnimation.disabled = false;
				dropFillType.disabled = false;
				dropFillRange.disabled = false;

				
				if( ledOnCount > 0 ){
					butClock.disabled = false;
					butCounterClock.disabled = false;
					if( ledOnCount<24 ){ but_edit_fill.disabled = false; }
					butPush.disabled = false;
					butPull.disabled = false;
				}

				if( ledColCount > 1 ){
					if( ledOnCount<24 ){ but_edit_flow.disabled = false; }
				}

				if(count_frames < max_fields){
					butAddFrame.disabled = false;
					butCopyFrame.disabled = false;
				}
				if( undoPointer > 0 ){ butUndo.disabled = false; }
				if( undoPointer < undoList.length-1 ){ butRedo.disabled = false; }
			}
		}

		function actionUndo(action){
			if(action == undefined){ action = 'store'; }

			switch(action){
			case 'store':
				undoPointer ++;
				undoList[undoPointer] = ledFrames.slice(0);
				undoList.splice(undoPointer+1, undoList.length - undoPointer-1);
				break;

			case 'undo':
				if( undoPointer > 0 ){
					undoPointer --;
					ledFrames = undoList[undoPointer].slice(0);
					if( selectedFrame >= ledFrames.length ){ selectedFrame = ledFrames.length - 1; }
					ledFrame = ledFrames[ selectedFrame ].slice(0);
					refreshFramesList();
				}
				break;

			case 'redo':
				if( undoList.length > 0 && undoPointer < undoList.length-1 ){
					undoPointer ++;
					ledFrames = undoList[undoPointer].slice(0);
					if( selectedFrame >= ledFrames.length ){ selectedFrame = ledFrames.length - 1; }
					ledFrame = ledFrames[ selectedFrame ].slice(0);
					refreshFramesList();
				}
				break;
			}
			refreshButtons();
			saveAnimation();
		}
		</script>
	</body>
</html>
